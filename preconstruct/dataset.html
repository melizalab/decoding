<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.3.0"/>
    <title>preconstruct.dataset API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../preconstruct.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;preconstruct</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

        <h2>Contents</h2>
        <ul>
  <li><a href="#examples">Examples</a></li>
</ul>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#Dataset">Dataset</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Dataset.__init__">Dataset</a>
                        </li>
                        <li>
                                <a class="variable" href="#Dataset.responses">responses</a>
                        </li>
                        <li>
                                <a class="variable" href="#Dataset.trial_data">trial_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#Dataset.time_step">time_step</a>
                        </li>
                        <li>
                                <a class="variable" href="#Dataset.stimuli_format">stimuli_format</a>
                        </li>
                        <li>
                                <a class="function" href="#Dataset.to_steps">to_steps</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DatasetBuilder">DatasetBuilder</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DatasetBuilder.__init__">DatasetBuilder</a>
                        </li>
                        <li>
                                <a class="function" href="#DatasetBuilder.set_data_source">set_data_source</a>
                        </li>
                        <li>
                                <a class="function" href="#DatasetBuilder.load_responses">load_responses</a>
                        </li>
                        <li>
                                <a class="function" href="#DatasetBuilder.bin_responses">bin_responses</a>
                        </li>
                        <li>
                                <a class="function" href="#DatasetBuilder.add_stimuli">add_stimuli</a>
                        </li>
                        <li>
                                <a class="function" href="#DatasetBuilder.create_time_lags">create_time_lags</a>
                        </li>
                        <li>
                                <a class="function" href="#DatasetBuilder.pool_trials">pool_trials</a>
                        </li>
                        <li>
                                <a class="function" href="#DatasetBuilder.get_dataset">get_dataset</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#InvalidConstructionSequence">InvalidConstructionSequence</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#InvalidConstructionSequence.__init__">InvalidConstructionSequence</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#IncompatibleTrialError">IncompatibleTrialError</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#IncompatibleTrialError.__init__">IncompatibleTrialError</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#InconsistentStimulusInterval">InconsistentStimulusInterval</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#IncompatibleStimulusSamplingRates">IncompatibleStimulusSamplingRates</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#IncompatibleStimuliFormat">IncompatibleStimuliFormat</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#IncompatibleStimuliFormat.__init__">IncompatibleStimuliFormat</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TimestepSetTwice">TimestepSetTwice</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TimestepSetTwice.__init__">TimestepSetTwice</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../preconstruct.html">preconstruct</a><wbr>.dataset    </h1>

                        <div class="docstring"><p>Loading data for neural decoding</p>

<h2 id="examples">Examples</h2>

<p>Let's build a simple dataset for neural decoding. The first step is determining
what data we'll use. Depending on where our data is stored we'll use different
classes that inherit from <a href="sources.html#DataSource">preconstruct.sources.DataSource</a>. For example, if we want to
use data from a local folder on our computer we might use <a href="sources.html#FsSource">preconstruct.sources.FsSource</a>.
For other options, see <a href="sources.html">preconstruct.sources</a>. In this example, we'll use
<a href="sources.html#NeurobankSource">preconstruct.sources.NeurobankSource</a>, which will automatically download a list of
identifiers from Neurobank. Let's suppose we know we want to use a pprox responses
from two files with identifiers <code>P120_1_1_c92</code> and <code>P120_1_1_c89</code>.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn"><a href="sources.html">preconstruct.sources</a></span> <span class="kn">import</span> <span class="n">NeurobankSource</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">responses</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;P120_1_1_c92&#39;</span><span class="p">,</span> <span class="s1">&#39;P120_1_1_c89&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stimuli</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># we&#39;ll leave this empty for now</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_source</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">NeurobankSource</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stimuli</span><span class="p">,</span> <span class="n">responses</span><span class="p">))</span>
</code></pre>
</div>

<p>We can't use this <code>DataSource</code> to build a dataset because it doesn't contain any
of the stimuli that were presented during the recording, but we can easily get
a list of the stimuli identifiers:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">stimuli</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_source</span><span class="o">.</span><span class="n">stimuli_names_from_pprox</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">stimuli</span><span class="p">)</span>
<span class="go">[&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;, &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</code></pre>
</div>

<p>Let's make a new DataSource that includes the stimuli</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">data_source</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">NeurobankSource</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stimuli</span><span class="p">,</span> <span class="n">responses</span><span class="p">))</span>
</code></pre>
</div>

<p>Now we can start building our dataset. We will put our data into a
<code><a href="#DatasetBuilder">DatasetBuilder</a></code>, which will allow us to configure the format of our dataset.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn"><a href="">preconstruct.dataset</a></span> <span class="kn">import</span> <span class="n">DatasetBuilder</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span> <span class="o">=</span> <span class="n">DatasetBuilder</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span><span class="o">.</span><span class="n">set_data_source</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span><span class="o">.</span><span class="n">load_responses</span><span class="p">()</span>
</code></pre>
</div>

<p>The first choice we have to make is how to represent the stimulus. Auditory
stimuli are converted to spectrograms with one or more frequency channels. An
important choice is the size of the time step, as this determines the
granularity of the time axis for both the spikes and the stimuli. The unit for
this argument and all other time values will be seconds. Note that due to the
discrete sampling rate of the stimulus, the actual time step may be slightly
larger or smaller than requested.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn"><a href="stimuliformats.html">preconstruct.stimuliformats</a></span> <span class="kn">import</span> <span class="n">Gammatone</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span><span class="o">.</span><span class="n">add_stimuli</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">Gammatone</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">window_time</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">frequency_bin_count</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">min_frequency</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">max_frequency</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">log_transform_compress</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span>    <span class="n">time_step</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>       <span class="c1"># 5 ms</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre>
</div>

<p>Once the time resolution is set by the stimulus, the spike times can be binned:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span><span class="o">.</span><span class="n">bin_responses</span><span class="p">()</span>
</code></pre>
</div>

<p>Now we will convert the binned spikes into a lagged matrix, with a with a window
of size tau.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span><span class="o">.</span><span class="n">create_time_lags</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</code></pre>
</div>

<p>Our next step is to combine data from multiple presentations of the same stimulus.
(This is optional.)</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span><span class="o">.</span><span class="n">pool_trials</span><span class="p">()</span>
</code></pre>
</div>

<p>We have finished building our dataset.
We should investigate our object a bit, to make sure we understand how
it's structured.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">dataset</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">dataset</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">index</span>
<span class="go">MultiIndex([(&#39;c95zqjxq&#39;,                1.0),</span>
<span class="go">            (&#39;c95zqjxq&#39;, 1.0050000000000001),</span>
<span class="go">            (&#39;c95zqjxq&#39;,               1.01),</span>
<span class="go">            (&#39;c95zqjxq&#39;, 1.0150000000000001),</span>
<span class="go">            (&#39;c95zqjxq&#39;,               1.02),</span>
<span class="go">            (&#39;c95zqjxq&#39;,              1.025),</span>
<span class="go">            (&#39;c95zqjxq&#39;,               1.03),</span>
<span class="go">            (&#39;c95zqjxq&#39;,              1.035),</span>
<span class="go">            (&#39;c95zqjxq&#39;,               1.04),</span>
<span class="go">            (&#39;c95zqjxq&#39;,              1.045),</span>
<span class="go">            ...</span>
<span class="go">            (&#39;ztqee46x&#39;,              3.095),</span>
<span class="go">            (&#39;ztqee46x&#39;,                3.1),</span>
<span class="go">            (&#39;ztqee46x&#39;,              3.105),</span>
<span class="go">            (&#39;ztqee46x&#39;,               3.11),</span>
<span class="go">            (&#39;ztqee46x&#39;,              3.115),</span>
<span class="go">            (&#39;ztqee46x&#39;,               3.12),</span>
<span class="go">            (&#39;ztqee46x&#39;,              3.125),</span>
<span class="go">            (&#39;ztqee46x&#39;,               3.13),</span>
<span class="go">            (&#39;ztqee46x&#39;, 3.1350000000000002),</span>
<span class="go">            (&#39;ztqee46x&#39;,               3.14)],</span>
<span class="go">           names=[&#39;stimulus.name&#39;, &#39;time&#39;], length=4112)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dataset</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">columns</span>
<span class="go">MultiIndex([(&#39;P120_1_1_c89&#39;,                 0.0),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,               0.005),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,                0.01),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,               0.015),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,                0.02),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,               0.025),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,                0.03),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,               0.035),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,                0.04),</span>
<span class="go">            (&#39;P120_1_1_c89&#39;,               0.045),</span>
<span class="go">            ...</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,                0.25),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,               0.255),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,                0.26),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,               0.265),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,                0.27),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,               0.275),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,                0.28),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;, 0.28500000000000003),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,                0.29),</span>
<span class="go">            (&#39;P120_1_1_c92&#39;,               0.295)],</span>
<span class="go">           names=[&#39;neuron&#39;, &#39;offset&#39;], length=120)</span>
</code></pre>
</div>

<p>Let's use our dataset to perform a simple neural decoding task</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">training_stimuli</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;c95zqjxq&#39;</span><span class="p">,</span> <span class="s1">&#39;g29wxi4q&#39;</span><span class="p">,</span> <span class="s1">&#39;igmi8fxa&#39;</span><span class="p">,</span> <span class="s1">&#39;jkexyrd5&#39;</span><span class="p">,</span> <span class="s1">&#39;l1a3ltpy&#39;</span><span class="p">,</span> <span class="s1">&#39;mrel2o09&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">test_stimuli</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;stimulus.name&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">training_stimuli</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">training_stimuli</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
<span class="go">((2476, 120), (2476, 50))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="go">Ridge()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="go">0.30159992</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">test_stimuli</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
<span class="go">0.15341238</span>
</code></pre>
</div>
</div>

                        <input id="mod-dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-dataset-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;Loading data for neural decoding</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">## Examples</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">Let&#39;s build a simple dataset for neural decoding. The first step is determining</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">what data we&#39;ll use. Depending on where our data is stored we&#39;ll use different</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">classes that inherit from preconstruct.sources.DataSource. For example, if we want to</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">use data from a local folder on our computer we might use preconstruct.sources.FsSource.</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">For other options, see preconstruct.sources. In this example, we&#39;ll use</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">preconstruct.sources.NeurobankSource, which will automatically download a list of</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">identifiers from Neurobank. Let&#39;s suppose we know we want to use a pprox responses</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">from two files with identifiers `P120_1_1_c92` and `P120_1_1_c89`.</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">&gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">&gt;&gt;&gt; import asyncio</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">&gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;, &#39;P120_1_1_c89&#39;]</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">&gt;&gt;&gt; stimuli = [] # we&#39;ll leave this empty for now</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">&gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">&gt;&gt;&gt; test_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">We can&#39;t use this `DataSource` to build a dataset because it doesn&#39;t contain any</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">of the stimuli that were presented during the recording, but we can easily get</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">a list of the stimuli identifiers:</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">&gt;&gt;&gt; stimuli = list(test_source.stimuli_names_from_pprox())</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">&gt;&gt;&gt; sorted(stimuli)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">[&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;, &#39;mrel2o09&#39;, \</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">&#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">Let&#39;s make a new DataSource that includes the stimuli</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">&gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">Now we can start building our dataset. We will put our data into a</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">`DatasetBuilder`, which will allow us to configure the format of our dataset.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">&gt;&gt;&gt; from preconstruct.dataset import DatasetBuilder</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">&gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">&gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">&gt;&gt;&gt; builder.load_responses()</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">The first choice we have to make is how to represent the stimulus. Auditory</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">stimuli are converted to spectrograms with one or more frequency channels. An</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">important choice is the size of the time step, as this determines the</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">granularity of the time axis for both the spikes and the stimuli. The unit for</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">this argument and all other time values will be seconds. Note that due to the</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">discrete sampling rate of the stimulus, the actual time step may be slightly</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">larger or smaller than requested.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">&gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">&gt;&gt;&gt; builder.add_stimuli(</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">...     Gammatone(</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">...         window_time=0.005,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">...         frequency_bin_count=50,</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">...         min_frequency=500,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">...         max_frequency=8000,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">...         log_transform_compress=1,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">...     ),</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">...     time_step=0.005,       # 5 ms</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">... )</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">Once the time resolution is set by the stimulus, the spike times can be binned:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">&gt;&gt;&gt; builder.bin_responses()</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">Now we will convert the binned spikes into a lagged matrix, with a with a window</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">of size tau.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">&gt;&gt;&gt; builder.create_time_lags(tau=0.3)</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">Our next step is to combine data from multiple presentations of the same stimulus.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">(This is optional.)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">&gt;&gt;&gt; builder.pool_trials()</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">We have finished building our dataset.</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">We should investigate our object a bit, to make sure we understand how</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">it&#39;s structured.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">&gt;&gt;&gt; dataset = builder.get_dataset()</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">&gt;&gt;&gt; dataset.responses.index</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">MultiIndex([(&#39;c95zqjxq&#39;,                1.0),</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">            (&#39;c95zqjxq&#39;, 1.0050000000000001),</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">            (&#39;c95zqjxq&#39;,               1.01),</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">            (&#39;c95zqjxq&#39;, 1.0150000000000001),</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">            (&#39;c95zqjxq&#39;,               1.02),</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">            (&#39;c95zqjxq&#39;,              1.025),</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">            (&#39;c95zqjxq&#39;,               1.03),</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">            (&#39;c95zqjxq&#39;,              1.035),</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">            (&#39;c95zqjxq&#39;,               1.04),</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">            (&#39;c95zqjxq&#39;,              1.045),</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">            ...</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">            (&#39;ztqee46x&#39;,              3.095),</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">            (&#39;ztqee46x&#39;,                3.1),</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">            (&#39;ztqee46x&#39;,              3.105),</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">            (&#39;ztqee46x&#39;,               3.11),</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">            (&#39;ztqee46x&#39;,              3.115),</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">            (&#39;ztqee46x&#39;,               3.12),</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">            (&#39;ztqee46x&#39;,              3.125),</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">            (&#39;ztqee46x&#39;,               3.13),</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">            (&#39;ztqee46x&#39;, 3.1350000000000002),</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">            (&#39;ztqee46x&#39;,               3.14)],</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">           names=[&#39;stimulus.name&#39;, &#39;time&#39;], length=4112)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">&gt;&gt;&gt; dataset.responses.columns</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">MultiIndex([(&#39;P120_1_1_c89&#39;,                 0.0),</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,               0.005),</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,                0.01),</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,               0.015),</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,                0.02),</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,               0.025),</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,                0.03),</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,               0.035),</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,                0.04),</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">            (&#39;P120_1_1_c89&#39;,               0.045),</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">            ...</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,                0.25),</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,               0.255),</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,                0.26),</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,               0.265),</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,                0.27),</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,               0.275),</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,                0.28),</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;, 0.28500000000000003),</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,                0.29),</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">            (&#39;P120_1_1_c92&#39;,               0.295)],</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">           names=[&#39;neuron&#39;, &#39;offset&#39;], length=120)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">Let&#39;s use our dataset to perform a simple neural decoding task</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">&gt;&gt;&gt; from sklearn.linear_model import Ridge</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">&gt;&gt;&gt; import numpy as np</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">&gt;&gt;&gt; training_stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;, &#39;mrel2o09&#39;]</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">&gt;&gt;&gt; test_stimuli = set(dataset.responses.index.get_level_values(level=&#39;stimulus.name&#39;)).difference(training_stimuli)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">&gt;&gt;&gt; X, Y = dataset[list(training_stimuli)]</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">&gt;&gt;&gt; X.shape, Y.shape</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">((2476, 120), (2476, 50))</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">&gt;&gt;&gt; model = Ridge(alpha=1.0)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">&gt;&gt;&gt; model.fit(X, Y)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">Ridge()</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">&gt;&gt;&gt; model.score(X, Y)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">0.30159992</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">&gt;&gt;&gt; X_test, Y_test = dataset[list(test_stimuli)]</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">&gt;&gt;&gt; model.score(X_test, Y_test)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">0.15341238</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">hankel</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="kn">from</span> <span class="nn">preconstruct.sources</span> <span class="kn">import</span> <span class="n">DataSource</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="kn">from</span> <span class="nn">preconstruct.basisfunctions</span> <span class="kn">import</span> <span class="n">Basis</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="kn">from</span> <span class="nn">preconstruct.stimuliformats</span> <span class="kn">import</span> <span class="n">StimuliFormat</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="k">class</span> <span class="nc">Dataset</span><span class="p">:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>    <span class="sd">&quot;&quot;&quot;Holds constructed response matrix and stimuli</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">    [Quick guide to Pandas indexing](https://pandas.pydata.org/docs/getting_started/intro_tutorials/03_subset_data.html#min-tut-03-subset)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">    Note: You can index straight into a `Dataset` object to get stimuli and</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">    responses in numpy array format, but you must select rows rather than</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">    columns. This corresponds to the `df.loc[]` Pandas syntax, rather than</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">    `df[]`.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">    &lt;!--</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">    &gt;&gt;&gt; import asyncio</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">    &gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">    &gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">    &gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;]</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">    &gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">    &gt;&gt;&gt; stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;,</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">    ...         &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">    &gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">    &gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">    &gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">    &gt;&gt;&gt; builder.load_responses()</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">    &gt;&gt;&gt; builder.add_stimuli(Gammatone(</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">    ...     window_time=0.005,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">    ...     frequency_bin_count=50,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">    ...     min_frequency=500,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">    ...     max_frequency=8000,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">    ...     log_transform_compress=1,</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">    ... ), time_step=0.005)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">    &gt;&gt;&gt; builder.bin_responses()</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">    &gt;&gt;&gt; builder.create_time_lags(tau=0.3)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="sd">    --&gt;</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">    &gt;&gt;&gt; dataset = builder.get_dataset()</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">    &gt;&gt;&gt; X, Y = dataset[20:30]</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">    &gt;&gt;&gt; X.shape</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">    (4600, 60)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">    &gt;&gt;&gt; Y.shape</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">    (4600, 50)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">    You can also manually select directly from the DataFrames.</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>    <span class="n">responses</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="sd">&quot;&quot;&quot;Columns correspond to pprox files</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>    <span class="n">stimuli</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>    <span class="n">trial_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>    <span class="sd">&quot;&quot;&quot;Each row corresponds to a trial and each column corresponds to a key in the</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">    pprox</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>    <span class="n">time_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    <span class="sd">&quot;&quot;&quot;granularity of time&quot;&quot;&quot;</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="n">stimuli_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StimuliFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>    <span class="sd">&quot;&quot;&quot;format of the stimuli&quot;&quot;&quot;</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>    <span class="k">def</span> <span class="nf">_get_stimuli</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;add_stimuli&quot;</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>    <span class="k">def</span> <span class="nf">_get_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;add_stimuli&quot;</span><span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="n">first_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="k">return</span> <span class="n">first_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>    <span class="k">def</span> <span class="nf">_get_trial_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;load_responses&quot;</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_data</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>    <span class="k">def</span> <span class="nf">_get_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;load_responses&quot;</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        get numpy arrays representing the responses and the stimuli</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        at the given pandas index range. The array dimensions are (time, neuron * lag).</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        The dimensions of the stimulus will depend on the StimuliFormat chosen.</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="n">selection</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>            <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="p">)</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="n">stimuli_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">][</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>            <span class="n">stimuli_index</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="n">stimuli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stimuli_format</span><span class="p">()</span><span class="o">.</span><span class="n">to_values</span><span class="p">(</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_stimuli</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stimuli_index</span><span class="p">]</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="k">return</span> <span class="n">responses</span><span class="p">,</span> <span class="n">stimuli</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>    <span class="k">def</span> <span class="nf">_get_stimuli_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StimuliFormat</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;add_stimuli&quot;</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli_format</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>    <span class="k">def</span> <span class="nf">to_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_in_seconds</span><span class="p">):</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="sd">&quot;&quot;&quot;Converts a time in seconds to a time in steps&quot;&quot;&quot;</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_in_seconds</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_step</span><span class="p">())</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="k">class</span> <span class="nc">DatasetBuilder</span><span class="p">:</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="sd">&quot;&quot;&quot;Construct instances of the `Dataset` class using the [builder</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">    pattern](https://refactoring.guru/design-patterns/builder)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>    <span class="n">data_source</span><span class="p">:</span> <span class="n">DataSource</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>    <span class="n">tau</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>    <span class="n">basis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">_EmptySource</span><span class="p">()</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>    <span class="k">def</span> <span class="nf">set_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source</span><span class="p">:</span> <span class="n">DataSource</span><span class="p">):</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>    <span class="k">def</span> <span class="nf">load_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="k">if</span> <span class="n">ignore_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>            <span class="n">ignore_columns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">get_responses</span><span class="p">()</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;no clusters&quot;</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="n">trial_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="p">{</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;pprox&quot;</span><span class="p">])</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;trial&quot;</span><span class="p">})</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;trial&quot;</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="p">},</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="n">trial_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;neuron&quot;</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="n">ignore_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="n">trial_data</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">ignore_columns</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="n">single_trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_trials</span><span class="p">(</span><span class="n">trial_data</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="k">assert</span> <span class="n">single_trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">trial_data</span> <span class="o">=</span> <span class="n">single_trial</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">trial_data</span> <span class="o">=</span> <span class="n">trial_data</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>    <span class="k">def</span> <span class="nf">_aggregate_trials</span><span class="p">(</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="n">trial_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="sd">&quot;&quot;&quot;combine corresponding trials across different pprox files</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">        if all trials contain the same data, return one trial</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">        otherwise, raise a IncompatibleTrialError</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="n">trials</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="n">first</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                <span class="n">first</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="n">first_name</span><span class="p">,</span> <span class="n">first_df</span> <span class="o">=</span> <span class="n">first</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_df</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                <span class="k">raise</span> <span class="n">IncompatibleTrialError</span><span class="p">({</span><span class="n">first_name</span><span class="p">:</span> <span class="n">first_df</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">t</span><span class="p">})</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="k">return</span> <span class="n">first</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>    <span class="k">def</span> <span class="nf">_extrapolate_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim_name</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="sd">&quot;&quot;&quot; Extrapolate the bins defined over a stimulus interval to the recorded interval &quot;&quot;&quot;</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="c1"># The assumption is that the bins are evenly spaced.</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>    <span class="k">def</span> <span class="nf">bin_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">        transform a point process into bins containing the number of events (or if `normalize` </span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">        is True, the rate of events) that occurred within the time bin. Time bins are set based on</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="sd">        the stimulus, so this has to be called after add_stimuli()</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">trials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="n">spike_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="n">stimuli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_stimuli</span><span class="p">()</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="n">stim_name</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="n">interval</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="n">stim_bins</span> <span class="o">=</span> <span class="n">stimuli</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="n">time_step</span> <span class="o">=</span> <span class="n">stim_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">stim_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_step</span><span class="p">,</span> <span class="o">-</span><span class="n">time_step</span><span class="p">)[:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>                <span class="n">stim_bins</span><span class="p">,</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">time_step</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>            <span class="p">])</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">(</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>                <span class="n">df</span><span class="p">[</span><span class="n">spike_times</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>                <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>                    <span class="k">lambda</span> <span class="n">spikes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>                <span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>            <span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">/</span> <span class="n">time_step</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                <span class="n">arr</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                    <span class="p">[[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                <span class="p">),</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>                <span class="n">columns</span><span class="o">=</span><span class="n">spike_times</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>            <span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="p">[</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">spike_times</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>    <span class="k">def</span> <span class="nf">add_stimuli</span><span class="p">(</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">stimuli_format</span><span class="p">:</span> <span class="n">StimuliFormat</span><span class="p">,</span> <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    <span class="p">):</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        Add a dataframe containing formatted stimuli for each</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">        stimulus associated with a trial</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">        Consult documentation for `preconstruct.stimuliformats` for details.</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">        ###### example</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">        &lt;!--</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="sd">        &gt;&gt;&gt; import asyncio</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        &gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;]</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">        &gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">        &gt;&gt;&gt; stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;,</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">        ...         &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">        &gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">        &gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">        &gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">        &gt;&gt;&gt; builder.load_responses()</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        --&gt;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        &gt;&gt;&gt; builder.add_stimuli(Gammatone(</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">        ...     window_time=0.001,</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        ...     frequency_bin_count=50,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">        ...     min_frequency=500,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        ...     max_frequency=8000,</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">        ... ), time_step=0.005) # 5 ms</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli_format</span> <span class="o">=</span> <span class="n">stimuli_format</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli</span> <span class="o">=</span> <span class="n">stimuli_format</span><span class="o">.</span><span class="n">create_dataframe</span><span class="p">(</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>            <span class="n">time_step</span><span class="p">,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;stimulus.interval&quot;</span><span class="p">]]</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">)[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">],</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>        <span class="n">time_steps</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">time_steps</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="k">raise</span> <span class="n">IncompatibleStimulusSamplingRates</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">create_time_lags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.300</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Basis</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">        `tau`: length of window (in secs) to consider in prediction</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">        `basis`: an instance of a class that inherits from</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">        `preconstruct.basisfunctions.Basis`, initialized with the dimension</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">        of the projection</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">        ###### example</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">        &lt;!--</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">        &gt;&gt;&gt; import asyncio</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        &gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;]</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a><span class="sd">        &gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        &gt;&gt;&gt; stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;,</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        ...         &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">        &gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        &gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">        &gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">        &gt;&gt;&gt; builder.load_responses()</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a><span class="sd">        &gt;&gt;&gt; builder.bin_responses(time_step=0.005) # 5 ms</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">        &gt;&gt;&gt; builder.add_stimuli(Gammatone())</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">        --&gt;</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.basisfunctions import RaisedCosineBasis</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a><span class="sd">        &gt;&gt;&gt; builder.create_time_lags(tau=0.3, basis=RaisedCosineBasis(30))</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>            <span class="n">window_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">to_steps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">get_basis</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="c1"># figure out if trials have been pooled and adjust accordingly</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="n">common_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                <span class="k">lambda</span> <span class="n">neuron</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>                    <span class="p">[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">,</span> <span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                <span class="p">]</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                    <span class="n">neuron</span><span class="p">[</span><span class="n">neuron</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># convert to series</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                    <span class="n">on</span><span class="o">=</span><span class="n">common_index</span><span class="p">,</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                <span class="p">)</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_stimuli</span><span class="p">()</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;stimulus.length&quot;</span><span class="p">),</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">common_index</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stagger</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>    <span class="k">def</span> <span class="nf">_stagger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="p">[</span><span class="n">stimulus_interval</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="n">stim_start</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stimulus_interval</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">stim_start</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="n">window_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">to_steps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="p">[</span><span class="n">stimulus_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stimulus.length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">stimulus_length</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">window_length</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        <span class="n">time_lagged</span> <span class="o">=</span> <span class="n">hankel</span><span class="p">(</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="n">events</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">events</span><span class="p">[</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">window_length</span><span class="p">]</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_time_step</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;offset&quot;</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>            <span class="n">time_lagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">time_lagged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>            <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="n">time_lagged</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>            <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>    <span class="k">def</span> <span class="nf">pool_trials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="sd">&quot;&quot;&quot;Pool spikes across trials&quot;&quot;&quot;</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">)[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">]</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ser</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="p">):</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>            <span class="k">raise</span> <span class="n">InconsistentStimulusInterval</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;bin_responses&quot;</span><span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>        <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="k">del</span> <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">]</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>        <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>            <span class="s2">&quot;sum&quot;</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="sd">&quot;&quot;&quot;Return the fully constructed `Dataset` object&quot;&quot;&quot;</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="k">class</span> <span class="nc">_EmptySource</span><span class="p">(</span><span class="n">DataSource</span><span class="p">):</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>    <span class="k">def</span> <span class="nf">_get_raw_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise</span><span class="p">()</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="k">def</span> <span class="nf">get_stimuli</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raise</span><span class="p">()</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="k">def</span> <span class="nf">_raise</span><span class="p">():</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;DatasetBuilder.set_data_source&quot;</span><span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a><span class="k">class</span> <span class="nc">InvalidConstructionSequence</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>    <span class="sd">&quot;&quot;&quot;Indicates that the methods of a DatasetBuilder have been called in an invalid order&quot;&quot;&quot;</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_method</span><span class="p">):</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">required_method</span> <span class="o">=</span> <span class="n">required_method</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="sa">f</span><span class="s2">&quot;invalid construction sequence: must call `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">required_method</span><span class="si">}</span><span class="s2">` first&quot;</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="k">class</span> <span class="nc">IncompatibleTrialError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>    <span class="sd">&quot;&quot;&quot;Raised when corresponding trials from different pprox files differ</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a><span class="sd">    If the differing trial data is expected, you can choose to not include</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a><span class="sd">    specific keys using the `ignore_columns` argument in</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a><span class="sd">    `DatasetBuilder.load_responses`.</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial_pair</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]):</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span> <span class="o">=</span> <span class="n">trial_pair</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>            <span class="sa">f</span><span class="s2">&quot;at least two trials contained conflicting data: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span><span class="p">[</span><span class="n">b</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>        <span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a><span class="k">class</span> <span class="nc">InconsistentStimulusInterval</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>    <span class="sd">&quot;&quot;&quot;Raised when stimulus.interval differs between trials that are to be combined&quot;&quot;&quot;</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="s2">&quot;if you want to pool trials, every stimulus presentation must have&quot;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>            <span class="s2">&quot; the same stimulus.interval&quot;</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="k">class</span> <span class="nc">IncompatibleStimulusSamplingRates</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>    <span class="sd">&quot;&quot;&quot;Raised when it&#39;s not possible for all stimuli to have the desired time step&quot;&quot;&quot;</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>            <span class="s2">&quot;Stimuli have different sampling rates, and it&#39;s not possible for&quot;</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>            <span class="s2">&quot; them to all have the same time step&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="k">class</span> <span class="nc">IncompatibleStimuliFormat</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="nb">format</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>            <span class="sa">f</span><span class="s2">&quot;the StimuliFormat you have picked (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>            <span class="s2">&quot; is not a subclass of `SameTimeIndexAsResponse`&quot;</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="s2">&quot; so you can&#39;t call this function&quot;</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a><span class="k">class</span> <span class="nc">TimestepSetTwice</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;You can only set time_step once&quot;</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="Dataset">
                            <input id="Dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Dataset</span>:

                <label class="view-source-button" for="Dataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Dataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Dataset-151"><a href="#Dataset-151"><span class="linenos">151</span></a><span class="k">class</span> <span class="nc">Dataset</span><span class="p">:</span>
</span><span id="Dataset-152"><a href="#Dataset-152"><span class="linenos">152</span></a>    <span class="sd">&quot;&quot;&quot;Holds constructed response matrix and stimuli</span>
</span><span id="Dataset-153"><a href="#Dataset-153"><span class="linenos">153</span></a>
</span><span id="Dataset-154"><a href="#Dataset-154"><span class="linenos">154</span></a><span class="sd">    [Quick guide to Pandas indexing](https://pandas.pydata.org/docs/getting_started/intro_tutorials/03_subset_data.html#min-tut-03-subset)</span>
</span><span id="Dataset-155"><a href="#Dataset-155"><span class="linenos">155</span></a>
</span><span id="Dataset-156"><a href="#Dataset-156"><span class="linenos">156</span></a><span class="sd">    Note: You can index straight into a `Dataset` object to get stimuli and</span>
</span><span id="Dataset-157"><a href="#Dataset-157"><span class="linenos">157</span></a><span class="sd">    responses in numpy array format, but you must select rows rather than</span>
</span><span id="Dataset-158"><a href="#Dataset-158"><span class="linenos">158</span></a><span class="sd">    columns. This corresponds to the `df.loc[]` Pandas syntax, rather than</span>
</span><span id="Dataset-159"><a href="#Dataset-159"><span class="linenos">159</span></a><span class="sd">    `df[]`.</span>
</span><span id="Dataset-160"><a href="#Dataset-160"><span class="linenos">160</span></a>
</span><span id="Dataset-161"><a href="#Dataset-161"><span class="linenos">161</span></a><span class="sd">    &lt;!--</span>
</span><span id="Dataset-162"><a href="#Dataset-162"><span class="linenos">162</span></a><span class="sd">    &gt;&gt;&gt; import asyncio</span>
</span><span id="Dataset-163"><a href="#Dataset-163"><span class="linenos">163</span></a><span class="sd">    &gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="Dataset-164"><a href="#Dataset-164"><span class="linenos">164</span></a><span class="sd">    &gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="Dataset-165"><a href="#Dataset-165"><span class="linenos">165</span></a><span class="sd">    &gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;]</span>
</span><span id="Dataset-166"><a href="#Dataset-166"><span class="linenos">166</span></a><span class="sd">    &gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="Dataset-167"><a href="#Dataset-167"><span class="linenos">167</span></a><span class="sd">    &gt;&gt;&gt; stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;,</span>
</span><span id="Dataset-168"><a href="#Dataset-168"><span class="linenos">168</span></a><span class="sd">    ...         &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="Dataset-169"><a href="#Dataset-169"><span class="linenos">169</span></a><span class="sd">    &gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="Dataset-170"><a href="#Dataset-170"><span class="linenos">170</span></a><span class="sd">    &gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="Dataset-171"><a href="#Dataset-171"><span class="linenos">171</span></a><span class="sd">    &gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="Dataset-172"><a href="#Dataset-172"><span class="linenos">172</span></a><span class="sd">    &gt;&gt;&gt; builder.load_responses()</span>
</span><span id="Dataset-173"><a href="#Dataset-173"><span class="linenos">173</span></a><span class="sd">    &gt;&gt;&gt; builder.add_stimuli(Gammatone(</span>
</span><span id="Dataset-174"><a href="#Dataset-174"><span class="linenos">174</span></a><span class="sd">    ...     window_time=0.005,</span>
</span><span id="Dataset-175"><a href="#Dataset-175"><span class="linenos">175</span></a><span class="sd">    ...     frequency_bin_count=50,</span>
</span><span id="Dataset-176"><a href="#Dataset-176"><span class="linenos">176</span></a><span class="sd">    ...     min_frequency=500,</span>
</span><span id="Dataset-177"><a href="#Dataset-177"><span class="linenos">177</span></a><span class="sd">    ...     max_frequency=8000,</span>
</span><span id="Dataset-178"><a href="#Dataset-178"><span class="linenos">178</span></a><span class="sd">    ...     log_transform_compress=1,</span>
</span><span id="Dataset-179"><a href="#Dataset-179"><span class="linenos">179</span></a><span class="sd">    ... ), time_step=0.005)</span>
</span><span id="Dataset-180"><a href="#Dataset-180"><span class="linenos">180</span></a><span class="sd">    &gt;&gt;&gt; builder.bin_responses()</span>
</span><span id="Dataset-181"><a href="#Dataset-181"><span class="linenos">181</span></a><span class="sd">    &gt;&gt;&gt; builder.create_time_lags(tau=0.3)</span>
</span><span id="Dataset-182"><a href="#Dataset-182"><span class="linenos">182</span></a>
</span><span id="Dataset-183"><a href="#Dataset-183"><span class="linenos">183</span></a><span class="sd">    --&gt;</span>
</span><span id="Dataset-184"><a href="#Dataset-184"><span class="linenos">184</span></a><span class="sd">    &gt;&gt;&gt; dataset = builder.get_dataset()</span>
</span><span id="Dataset-185"><a href="#Dataset-185"><span class="linenos">185</span></a><span class="sd">    &gt;&gt;&gt; X, Y = dataset[20:30]</span>
</span><span id="Dataset-186"><a href="#Dataset-186"><span class="linenos">186</span></a><span class="sd">    &gt;&gt;&gt; X.shape</span>
</span><span id="Dataset-187"><a href="#Dataset-187"><span class="linenos">187</span></a><span class="sd">    (4600, 60)</span>
</span><span id="Dataset-188"><a href="#Dataset-188"><span class="linenos">188</span></a><span class="sd">    &gt;&gt;&gt; Y.shape</span>
</span><span id="Dataset-189"><a href="#Dataset-189"><span class="linenos">189</span></a><span class="sd">    (4600, 50)</span>
</span><span id="Dataset-190"><a href="#Dataset-190"><span class="linenos">190</span></a>
</span><span id="Dataset-191"><a href="#Dataset-191"><span class="linenos">191</span></a><span class="sd">    You can also manually select directly from the DataFrames.</span>
</span><span id="Dataset-192"><a href="#Dataset-192"><span class="linenos">192</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Dataset-193"><a href="#Dataset-193"><span class="linenos">193</span></a>
</span><span id="Dataset-194"><a href="#Dataset-194"><span class="linenos">194</span></a>    <span class="n">responses</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Dataset-195"><a href="#Dataset-195"><span class="linenos">195</span></a>    <span class="sd">&quot;&quot;&quot;Columns correspond to pprox files</span>
</span><span id="Dataset-196"><a href="#Dataset-196"><span class="linenos">196</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Dataset-197"><a href="#Dataset-197"><span class="linenos">197</span></a>    <span class="n">stimuli</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Dataset-198"><a href="#Dataset-198"><span class="linenos">198</span></a>    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
</span><span id="Dataset-199"><a href="#Dataset-199"><span class="linenos">199</span></a>    <span class="n">trial_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Dataset-200"><a href="#Dataset-200"><span class="linenos">200</span></a>    <span class="sd">&quot;&quot;&quot;Each row corresponds to a trial and each column corresponds to a key in the</span>
</span><span id="Dataset-201"><a href="#Dataset-201"><span class="linenos">201</span></a><span class="sd">    pprox</span>
</span><span id="Dataset-202"><a href="#Dataset-202"><span class="linenos">202</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Dataset-203"><a href="#Dataset-203"><span class="linenos">203</span></a>    <span class="n">time_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Dataset-204"><a href="#Dataset-204"><span class="linenos">204</span></a>    <span class="sd">&quot;&quot;&quot;granularity of time&quot;&quot;&quot;</span>
</span><span id="Dataset-205"><a href="#Dataset-205"><span class="linenos">205</span></a>    <span class="n">stimuli_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StimuliFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Dataset-206"><a href="#Dataset-206"><span class="linenos">206</span></a>    <span class="sd">&quot;&quot;&quot;format of the stimuli&quot;&quot;&quot;</span>
</span><span id="Dataset-207"><a href="#Dataset-207"><span class="linenos">207</span></a>
</span><span id="Dataset-208"><a href="#Dataset-208"><span class="linenos">208</span></a>    <span class="k">def</span> <span class="nf">_get_stimuli</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="Dataset-209"><a href="#Dataset-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Dataset-210"><a href="#Dataset-210"><span class="linenos">210</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;add_stimuli&quot;</span><span class="p">)</span>
</span><span id="Dataset-211"><a href="#Dataset-211"><span class="linenos">211</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli</span>
</span><span id="Dataset-212"><a href="#Dataset-212"><span class="linenos">212</span></a>
</span><span id="Dataset-213"><a href="#Dataset-213"><span class="linenos">213</span></a>    <span class="k">def</span> <span class="nf">_get_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Dataset-214"><a href="#Dataset-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Dataset-215"><a href="#Dataset-215"><span class="linenos">215</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;add_stimuli&quot;</span><span class="p">)</span>
</span><span id="Dataset-216"><a href="#Dataset-216"><span class="linenos">216</span></a>        <span class="n">first_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Dataset-217"><a href="#Dataset-217"><span class="linenos">217</span></a>        <span class="k">return</span> <span class="n">first_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Dataset-218"><a href="#Dataset-218"><span class="linenos">218</span></a>
</span><span id="Dataset-219"><a href="#Dataset-219"><span class="linenos">219</span></a>    <span class="k">def</span> <span class="nf">_get_trial_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="Dataset-220"><a href="#Dataset-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Dataset-221"><a href="#Dataset-221"><span class="linenos">221</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;load_responses&quot;</span><span class="p">)</span>
</span><span id="Dataset-222"><a href="#Dataset-222"><span class="linenos">222</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_data</span>
</span><span id="Dataset-223"><a href="#Dataset-223"><span class="linenos">223</span></a>
</span><span id="Dataset-224"><a href="#Dataset-224"><span class="linenos">224</span></a>    <span class="k">def</span> <span class="nf">_get_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="Dataset-225"><a href="#Dataset-225"><span class="linenos">225</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Dataset-226"><a href="#Dataset-226"><span class="linenos">226</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;load_responses&quot;</span><span class="p">)</span>
</span><span id="Dataset-227"><a href="#Dataset-227"><span class="linenos">227</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span>
</span><span id="Dataset-228"><a href="#Dataset-228"><span class="linenos">228</span></a>
</span><span id="Dataset-229"><a href="#Dataset-229"><span class="linenos">229</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="Dataset-230"><a href="#Dataset-230"><span class="linenos">230</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Dataset-231"><a href="#Dataset-231"><span class="linenos">231</span></a><span class="sd">        get numpy arrays representing the responses and the stimuli</span>
</span><span id="Dataset-232"><a href="#Dataset-232"><span class="linenos">232</span></a><span class="sd">        at the given pandas index range. The array dimensions are (time, neuron * lag).</span>
</span><span id="Dataset-233"><a href="#Dataset-233"><span class="linenos">233</span></a><span class="sd">        The dimensions of the stimulus will depend on the StimuliFormat chosen.</span>
</span><span id="Dataset-234"><a href="#Dataset-234"><span class="linenos">234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Dataset-235"><a href="#Dataset-235"><span class="linenos">235</span></a>        <span class="n">selection</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Dataset-236"><a href="#Dataset-236"><span class="linenos">236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span>
</span><span id="Dataset-237"><a href="#Dataset-237"><span class="linenos">237</span></a>            <span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Dataset-238"><a href="#Dataset-238"><span class="linenos">238</span></a>            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="Dataset-239"><a href="#Dataset-239"><span class="linenos">239</span></a>            <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
</span><span id="Dataset-240"><a href="#Dataset-240"><span class="linenos">240</span></a>            <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="Dataset-241"><a href="#Dataset-241"><span class="linenos">241</span></a>        <span class="p">)</span>
</span><span id="Dataset-242"><a href="#Dataset-242"><span class="linenos">242</span></a>        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="Dataset-243"><a href="#Dataset-243"><span class="linenos">243</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Dataset-244"><a href="#Dataset-244"><span class="linenos">244</span></a>            <span class="n">stimuli_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selection</span><span class="p">][</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="Dataset-245"><a href="#Dataset-245"><span class="linenos">245</span></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="Dataset-246"><a href="#Dataset-246"><span class="linenos">246</span></a>            <span class="n">stimuli_index</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="Dataset-247"><a href="#Dataset-247"><span class="linenos">247</span></a>        <span class="n">stimuli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stimuli_format</span><span class="p">()</span><span class="o">.</span><span class="n">to_values</span><span class="p">(</span>
</span><span id="Dataset-248"><a href="#Dataset-248"><span class="linenos">248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_stimuli</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stimuli_index</span><span class="p">]</span>
</span><span id="Dataset-249"><a href="#Dataset-249"><span class="linenos">249</span></a>        <span class="p">)</span>
</span><span id="Dataset-250"><a href="#Dataset-250"><span class="linenos">250</span></a>        <span class="k">return</span> <span class="n">responses</span><span class="p">,</span> <span class="n">stimuli</span>
</span><span id="Dataset-251"><a href="#Dataset-251"><span class="linenos">251</span></a>
</span><span id="Dataset-252"><a href="#Dataset-252"><span class="linenos">252</span></a>    <span class="k">def</span> <span class="nf">_get_stimuli_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StimuliFormat</span><span class="p">:</span>
</span><span id="Dataset-253"><a href="#Dataset-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Dataset-254"><a href="#Dataset-254"><span class="linenos">254</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;add_stimuli&quot;</span><span class="p">)</span>
</span><span id="Dataset-255"><a href="#Dataset-255"><span class="linenos">255</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stimuli_format</span>
</span><span id="Dataset-256"><a href="#Dataset-256"><span class="linenos">256</span></a>
</span><span id="Dataset-257"><a href="#Dataset-257"><span class="linenos">257</span></a>    <span class="k">def</span> <span class="nf">to_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_in_seconds</span><span class="p">):</span>
</span><span id="Dataset-258"><a href="#Dataset-258"><span class="linenos">258</span></a>        <span class="sd">&quot;&quot;&quot;Converts a time in seconds to a time in steps&quot;&quot;&quot;</span>
</span><span id="Dataset-259"><a href="#Dataset-259"><span class="linenos">259</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_in_seconds</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_step</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Holds constructed response matrix and stimuli</p>

<p><a href="https://pandas.pydata.org/docs/getting_started/intro_tutorials/03_subset_data.html#min-tut-03-subset">Quick guide to Pandas indexing</a></p>

<p>Note: You can index straight into a <code><a href="#Dataset">Dataset</a></code> object to get stimuli and
responses in numpy array format, but you must select rows rather than
columns. This corresponds to the <code>df.loc[]</code> Pandas syntax, rather than
<code>df[]</code>.</p>

<!--



md5-3dc11fe4ce1181e067481fd255978726




-->

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">dataset</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(4600, 60)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(4600, 50)</span>
</code></pre>
</div>

<p>You can also manually select directly from the DataFrames.</p>
</div>


                            <div id="Dataset.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Dataset</span><span class="signature pdoc-code condensed">()</span>

        
    </div>
    <a class="headerlink" href="#Dataset.__init__"></a>
    
    

                            </div>
                            <div id="Dataset.responses" class="classattr">
                                <div class="attr variable">
            <span class="name">responses</span><span class="annotation">: Optional[pandas.core.frame.DataFrame]</span><span class="default_value"> = None</span>

        
    </div>
    <a class="headerlink" href="#Dataset.responses"></a>
    
            <div class="docstring"><p>Columns correspond to pprox files</p>
</div>


                            </div>
                            <div id="Dataset.trial_data" class="classattr">
                                <div class="attr variable">
            <span class="name">trial_data</span><span class="annotation">: Optional[pandas.core.frame.DataFrame]</span><span class="default_value"> = None</span>

        
    </div>
    <a class="headerlink" href="#Dataset.trial_data"></a>
    
            <div class="docstring"><p>Each row corresponds to a trial and each column corresponds to a key in the
pprox</p>
</div>


                            </div>
                            <div id="Dataset.time_step" class="classattr">
                                <div class="attr variable">
            <span class="name">time_step</span><span class="annotation">: Optional[float]</span><span class="default_value"> = None</span>

        
    </div>
    <a class="headerlink" href="#Dataset.time_step"></a>
    
            <div class="docstring"><p>granularity of time</p>
</div>


                            </div>
                            <div id="Dataset.stimuli_format" class="classattr">
                                <div class="attr variable">
            <span class="name">stimuli_format</span><span class="annotation">: Optional[<a href="stimuliformats.html#StimuliFormat">preconstruct.stimuliformats.StimuliFormat</a>]</span><span class="default_value"> = None</span>

        
    </div>
    <a class="headerlink" href="#Dataset.stimuli_format"></a>
    
            <div class="docstring"><p>format of the stimuli</p>
</div>


                            </div>
                            <div id="Dataset.to_steps" class="classattr">
                                        <input id="Dataset.to_steps-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_steps</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">time_in_seconds</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Dataset.to_steps-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Dataset.to_steps"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Dataset.to_steps-257"><a href="#Dataset.to_steps-257"><span class="linenos">257</span></a>    <span class="k">def</span> <span class="nf">to_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_in_seconds</span><span class="p">):</span>
</span><span id="Dataset.to_steps-258"><a href="#Dataset.to_steps-258"><span class="linenos">258</span></a>        <span class="sd">&quot;&quot;&quot;Converts a time in seconds to a time in steps&quot;&quot;&quot;</span>
</span><span id="Dataset.to_steps-259"><a href="#Dataset.to_steps-259"><span class="linenos">259</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_in_seconds</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_step</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Converts a time in seconds to a time in steps</p>
</div>


                            </div>
                </section>
                <section id="DatasetBuilder">
                            <input id="DatasetBuilder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DatasetBuilder</span>:

                <label class="view-source-button" for="DatasetBuilder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder-262"><a href="#DatasetBuilder-262"><span class="linenos">262</span></a><span class="k">class</span> <span class="nc">DatasetBuilder</span><span class="p">:</span>
</span><span id="DatasetBuilder-263"><a href="#DatasetBuilder-263"><span class="linenos">263</span></a>    <span class="sd">&quot;&quot;&quot;Construct instances of the `Dataset` class using the [builder</span>
</span><span id="DatasetBuilder-264"><a href="#DatasetBuilder-264"><span class="linenos">264</span></a><span class="sd">    pattern](https://refactoring.guru/design-patterns/builder)</span>
</span><span id="DatasetBuilder-265"><a href="#DatasetBuilder-265"><span class="linenos">265</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-266"><a href="#DatasetBuilder-266"><span class="linenos">266</span></a>
</span><span id="DatasetBuilder-267"><a href="#DatasetBuilder-267"><span class="linenos">267</span></a>    <span class="n">data_source</span><span class="p">:</span> <span class="n">DataSource</span>
</span><span id="DatasetBuilder-268"><a href="#DatasetBuilder-268"><span class="linenos">268</span></a>    <span class="n">tau</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
</span><span id="DatasetBuilder-269"><a href="#DatasetBuilder-269"><span class="linenos">269</span></a>    <span class="n">basis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
</span><span id="DatasetBuilder-270"><a href="#DatasetBuilder-270"><span class="linenos">270</span></a>
</span><span id="DatasetBuilder-271"><a href="#DatasetBuilder-271"><span class="linenos">271</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DatasetBuilder-272"><a href="#DatasetBuilder-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
</span><span id="DatasetBuilder-273"><a href="#DatasetBuilder-273"><span class="linenos">273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">_EmptySource</span><span class="p">()</span>
</span><span id="DatasetBuilder-274"><a href="#DatasetBuilder-274"><span class="linenos">274</span></a>
</span><span id="DatasetBuilder-275"><a href="#DatasetBuilder-275"><span class="linenos">275</span></a>    <span class="k">def</span> <span class="nf">set_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source</span><span class="p">:</span> <span class="n">DataSource</span><span class="p">):</span>
</span><span id="DatasetBuilder-276"><a href="#DatasetBuilder-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>
</span><span id="DatasetBuilder-277"><a href="#DatasetBuilder-277"><span class="linenos">277</span></a>
</span><span id="DatasetBuilder-278"><a href="#DatasetBuilder-278"><span class="linenos">278</span></a>    <span class="k">def</span> <span class="nf">load_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="DatasetBuilder-279"><a href="#DatasetBuilder-279"><span class="linenos">279</span></a>        <span class="k">if</span> <span class="n">ignore_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DatasetBuilder-280"><a href="#DatasetBuilder-280"><span class="linenos">280</span></a>            <span class="n">ignore_columns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DatasetBuilder-281"><a href="#DatasetBuilder-281"><span class="linenos">281</span></a>        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">get_responses</span><span class="p">()</span>
</span><span id="DatasetBuilder-282"><a href="#DatasetBuilder-282"><span class="linenos">282</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;no clusters&quot;</span>
</span><span id="DatasetBuilder-283"><a href="#DatasetBuilder-283"><span class="linenos">283</span></a>        <span class="n">trial_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="DatasetBuilder-284"><a href="#DatasetBuilder-284"><span class="linenos">284</span></a>            <span class="p">{</span>
</span><span id="DatasetBuilder-285"><a href="#DatasetBuilder-285"><span class="linenos">285</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;pprox&quot;</span><span class="p">])</span>
</span><span id="DatasetBuilder-286"><a href="#DatasetBuilder-286"><span class="linenos">286</span></a>                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;trial&quot;</span><span class="p">})</span>
</span><span id="DatasetBuilder-287"><a href="#DatasetBuilder-287"><span class="linenos">287</span></a>                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;trial&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder-288"><a href="#DatasetBuilder-288"><span class="linenos">288</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="DatasetBuilder-289"><a href="#DatasetBuilder-289"><span class="linenos">289</span></a>            <span class="p">},</span>
</span><span id="DatasetBuilder-290"><a href="#DatasetBuilder-290"><span class="linenos">290</span></a>            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="DatasetBuilder-291"><a href="#DatasetBuilder-291"><span class="linenos">291</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-292"><a href="#DatasetBuilder-292"><span class="linenos">292</span></a>        <span class="n">trial_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="DatasetBuilder-293"><a href="#DatasetBuilder-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;neuron&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder-294"><a href="#DatasetBuilder-294"><span class="linenos">294</span></a>        <span class="n">ignore_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder-295"><a href="#DatasetBuilder-295"><span class="linenos">295</span></a>        <span class="n">trial_data</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">ignore_columns</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DatasetBuilder-296"><a href="#DatasetBuilder-296"><span class="linenos">296</span></a>        <span class="n">single_trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_trials</span><span class="p">(</span><span class="n">trial_data</span><span class="p">)</span>
</span><span id="DatasetBuilder-297"><a href="#DatasetBuilder-297"><span class="linenos">297</span></a>        <span class="k">assert</span> <span class="n">single_trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="DatasetBuilder-298"><a href="#DatasetBuilder-298"><span class="linenos">298</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">trial_data</span> <span class="o">=</span> <span class="n">single_trial</span>
</span><span id="DatasetBuilder-299"><a href="#DatasetBuilder-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">trial_data</span> <span class="o">=</span> <span class="n">trial_data</span>
</span><span id="DatasetBuilder-300"><a href="#DatasetBuilder-300"><span class="linenos">300</span></a>
</span><span id="DatasetBuilder-301"><a href="#DatasetBuilder-301"><span class="linenos">301</span></a>    <span class="nd">@staticmethod</span>
</span><span id="DatasetBuilder-302"><a href="#DatasetBuilder-302"><span class="linenos">302</span></a>    <span class="k">def</span> <span class="nf">_aggregate_trials</span><span class="p">(</span>
</span><span id="DatasetBuilder-303"><a href="#DatasetBuilder-303"><span class="linenos">303</span></a>        <span class="n">trial_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="DatasetBuilder-304"><a href="#DatasetBuilder-304"><span class="linenos">304</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]]:</span>
</span><span id="DatasetBuilder-305"><a href="#DatasetBuilder-305"><span class="linenos">305</span></a>        <span class="sd">&quot;&quot;&quot;combine corresponding trials across different pprox files</span>
</span><span id="DatasetBuilder-306"><a href="#DatasetBuilder-306"><span class="linenos">306</span></a>
</span><span id="DatasetBuilder-307"><a href="#DatasetBuilder-307"><span class="linenos">307</span></a><span class="sd">        if all trials contain the same data, return one trial</span>
</span><span id="DatasetBuilder-308"><a href="#DatasetBuilder-308"><span class="linenos">308</span></a><span class="sd">        otherwise, raise a IncompatibleTrialError</span>
</span><span id="DatasetBuilder-309"><a href="#DatasetBuilder-309"><span class="linenos">309</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-310"><a href="#DatasetBuilder-310"><span class="linenos">310</span></a>        <span class="n">trials</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="DatasetBuilder-311"><a href="#DatasetBuilder-311"><span class="linenos">311</span></a>        <span class="n">first</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DatasetBuilder-312"><a href="#DatasetBuilder-312"><span class="linenos">312</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trials</span><span class="p">:</span>
</span><span id="DatasetBuilder-313"><a href="#DatasetBuilder-313"><span class="linenos">313</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="DatasetBuilder-314"><a href="#DatasetBuilder-314"><span class="linenos">314</span></a>            <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DatasetBuilder-315"><a href="#DatasetBuilder-315"><span class="linenos">315</span></a>                <span class="n">first</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="DatasetBuilder-316"><a href="#DatasetBuilder-316"><span class="linenos">316</span></a>            <span class="n">first_name</span><span class="p">,</span> <span class="n">first_df</span> <span class="o">=</span> <span class="n">first</span>
</span><span id="DatasetBuilder-317"><a href="#DatasetBuilder-317"><span class="linenos">317</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_df</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span id="DatasetBuilder-318"><a href="#DatasetBuilder-318"><span class="linenos">318</span></a>                <span class="k">raise</span> <span class="n">IncompatibleTrialError</span><span class="p">({</span><span class="n">first_name</span><span class="p">:</span> <span class="n">first_df</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">t</span><span class="p">})</span>
</span><span id="DatasetBuilder-319"><a href="#DatasetBuilder-319"><span class="linenos">319</span></a>        <span class="k">return</span> <span class="n">first</span>
</span><span id="DatasetBuilder-320"><a href="#DatasetBuilder-320"><span class="linenos">320</span></a>
</span><span id="DatasetBuilder-321"><a href="#DatasetBuilder-321"><span class="linenos">321</span></a>    <span class="k">def</span> <span class="nf">_extrapolate_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim_name</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
</span><span id="DatasetBuilder-322"><a href="#DatasetBuilder-322"><span class="linenos">322</span></a>        <span class="sd">&quot;&quot;&quot; Extrapolate the bins defined over a stimulus interval to the recorded interval &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-323"><a href="#DatasetBuilder-323"><span class="linenos">323</span></a>        <span class="c1"># The assumption is that the bins are evenly spaced.</span>
</span><span id="DatasetBuilder-324"><a href="#DatasetBuilder-324"><span class="linenos">324</span></a>
</span><span id="DatasetBuilder-325"><a href="#DatasetBuilder-325"><span class="linenos">325</span></a>    <span class="k">def</span> <span class="nf">bin_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="DatasetBuilder-326"><a href="#DatasetBuilder-326"><span class="linenos">326</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-327"><a href="#DatasetBuilder-327"><span class="linenos">327</span></a><span class="sd">        transform a point process into bins containing the number of events (or if `normalize` </span>
</span><span id="DatasetBuilder-328"><a href="#DatasetBuilder-328"><span class="linenos">328</span></a><span class="sd">        is True, the rate of events) that occurred within the time bin. Time bins are set based on</span>
</span><span id="DatasetBuilder-329"><a href="#DatasetBuilder-329"><span class="linenos">329</span></a><span class="sd">        the stimulus, so this has to be called after add_stimuli()</span>
</span><span id="DatasetBuilder-330"><a href="#DatasetBuilder-330"><span class="linenos">330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-331"><a href="#DatasetBuilder-331"><span class="linenos">331</span></a>        <span class="n">trials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()</span>
</span><span id="DatasetBuilder-332"><a href="#DatasetBuilder-332"><span class="linenos">332</span></a>        <span class="n">spike_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span>
</span><span id="DatasetBuilder-333"><a href="#DatasetBuilder-333"><span class="linenos">333</span></a>        <span class="n">stimuli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_stimuli</span><span class="p">()</span>
</span><span id="DatasetBuilder-334"><a href="#DatasetBuilder-334"><span class="linenos">334</span></a>
</span><span id="DatasetBuilder-335"><a href="#DatasetBuilder-335"><span class="linenos">335</span></a>        <span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span><span id="DatasetBuilder-336"><a href="#DatasetBuilder-336"><span class="linenos">336</span></a>            <span class="n">stim_name</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder-337"><a href="#DatasetBuilder-337"><span class="linenos">337</span></a>            <span class="n">interval</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder-338"><a href="#DatasetBuilder-338"><span class="linenos">338</span></a>            <span class="n">stim_bins</span> <span class="o">=</span> <span class="n">stimuli</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="DatasetBuilder-339"><a href="#DatasetBuilder-339"><span class="linenos">339</span></a>            <span class="n">time_step</span> <span class="o">=</span> <span class="n">stim_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">stim_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DatasetBuilder-340"><a href="#DatasetBuilder-340"><span class="linenos">340</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
</span><span id="DatasetBuilder-341"><a href="#DatasetBuilder-341"><span class="linenos">341</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_step</span><span class="p">,</span> <span class="o">-</span><span class="n">time_step</span><span class="p">)[:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="DatasetBuilder-342"><a href="#DatasetBuilder-342"><span class="linenos">342</span></a>                <span class="n">stim_bins</span><span class="p">,</span>
</span><span id="DatasetBuilder-343"><a href="#DatasetBuilder-343"><span class="linenos">343</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">time_step</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="DatasetBuilder-344"><a href="#DatasetBuilder-344"><span class="linenos">344</span></a>            <span class="p">])</span>
</span><span id="DatasetBuilder-345"><a href="#DatasetBuilder-345"><span class="linenos">345</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">(</span>
</span><span id="DatasetBuilder-346"><a href="#DatasetBuilder-346"><span class="linenos">346</span></a>                <span class="n">df</span><span class="p">[</span><span class="n">spike_times</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="DatasetBuilder-347"><a href="#DatasetBuilder-347"><span class="linenos">347</span></a>                <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="DatasetBuilder-348"><a href="#DatasetBuilder-348"><span class="linenos">348</span></a>                    <span class="k">lambda</span> <span class="n">spikes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="DatasetBuilder-349"><a href="#DatasetBuilder-349"><span class="linenos">349</span></a>                <span class="p">)</span>
</span><span id="DatasetBuilder-350"><a href="#DatasetBuilder-350"><span class="linenos">350</span></a>                <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="DatasetBuilder-351"><a href="#DatasetBuilder-351"><span class="linenos">351</span></a>                <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="DatasetBuilder-352"><a href="#DatasetBuilder-352"><span class="linenos">352</span></a>            <span class="p">)</span>
</span><span id="DatasetBuilder-353"><a href="#DatasetBuilder-353"><span class="linenos">353</span></a>            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
</span><span id="DatasetBuilder-354"><a href="#DatasetBuilder-354"><span class="linenos">354</span></a>                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">/</span> <span class="n">time_step</span>
</span><span id="DatasetBuilder-355"><a href="#DatasetBuilder-355"><span class="linenos">355</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="DatasetBuilder-356"><a href="#DatasetBuilder-356"><span class="linenos">356</span></a>                <span class="n">arr</span><span class="p">,</span>
</span><span id="DatasetBuilder-357"><a href="#DatasetBuilder-357"><span class="linenos">357</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
</span><span id="DatasetBuilder-358"><a href="#DatasetBuilder-358"><span class="linenos">358</span></a>                    <span class="p">[[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder-359"><a href="#DatasetBuilder-359"><span class="linenos">359</span></a>                <span class="p">),</span>
</span><span id="DatasetBuilder-360"><a href="#DatasetBuilder-360"><span class="linenos">360</span></a>                <span class="n">columns</span><span class="o">=</span><span class="n">spike_times</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
</span><span id="DatasetBuilder-361"><a href="#DatasetBuilder-361"><span class="linenos">361</span></a>            <span class="p">)</span>
</span><span id="DatasetBuilder-362"><a href="#DatasetBuilder-362"><span class="linenos">362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="DatasetBuilder-363"><a href="#DatasetBuilder-363"><span class="linenos">363</span></a>            <span class="p">[</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">spike_times</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="DatasetBuilder-364"><a href="#DatasetBuilder-364"><span class="linenos">364</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-365"><a href="#DatasetBuilder-365"><span class="linenos">365</span></a>
</span><span id="DatasetBuilder-366"><a href="#DatasetBuilder-366"><span class="linenos">366</span></a>    <span class="k">def</span> <span class="nf">add_stimuli</span><span class="p">(</span>
</span><span id="DatasetBuilder-367"><a href="#DatasetBuilder-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">stimuli_format</span><span class="p">:</span> <span class="n">StimuliFormat</span><span class="p">,</span> <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="DatasetBuilder-368"><a href="#DatasetBuilder-368"><span class="linenos">368</span></a>    <span class="p">):</span>
</span><span id="DatasetBuilder-369"><a href="#DatasetBuilder-369"><span class="linenos">369</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-370"><a href="#DatasetBuilder-370"><span class="linenos">370</span></a><span class="sd">        Add a dataframe containing formatted stimuli for each</span>
</span><span id="DatasetBuilder-371"><a href="#DatasetBuilder-371"><span class="linenos">371</span></a><span class="sd">        stimulus associated with a trial</span>
</span><span id="DatasetBuilder-372"><a href="#DatasetBuilder-372"><span class="linenos">372</span></a>
</span><span id="DatasetBuilder-373"><a href="#DatasetBuilder-373"><span class="linenos">373</span></a><span class="sd">        Consult documentation for `preconstruct.stimuliformats` for details.</span>
</span><span id="DatasetBuilder-374"><a href="#DatasetBuilder-374"><span class="linenos">374</span></a>
</span><span id="DatasetBuilder-375"><a href="#DatasetBuilder-375"><span class="linenos">375</span></a><span class="sd">        ###### example</span>
</span><span id="DatasetBuilder-376"><a href="#DatasetBuilder-376"><span class="linenos">376</span></a><span class="sd">        &lt;!--</span>
</span><span id="DatasetBuilder-377"><a href="#DatasetBuilder-377"><span class="linenos">377</span></a><span class="sd">        &gt;&gt;&gt; import asyncio</span>
</span><span id="DatasetBuilder-378"><a href="#DatasetBuilder-378"><span class="linenos">378</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="DatasetBuilder-379"><a href="#DatasetBuilder-379"><span class="linenos">379</span></a><span class="sd">        &gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;]</span>
</span><span id="DatasetBuilder-380"><a href="#DatasetBuilder-380"><span class="linenos">380</span></a><span class="sd">        &gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="DatasetBuilder-381"><a href="#DatasetBuilder-381"><span class="linenos">381</span></a><span class="sd">        &gt;&gt;&gt; stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;,</span>
</span><span id="DatasetBuilder-382"><a href="#DatasetBuilder-382"><span class="linenos">382</span></a><span class="sd">        ...         &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="DatasetBuilder-383"><a href="#DatasetBuilder-383"><span class="linenos">383</span></a><span class="sd">        &gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="DatasetBuilder-384"><a href="#DatasetBuilder-384"><span class="linenos">384</span></a><span class="sd">        &gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="DatasetBuilder-385"><a href="#DatasetBuilder-385"><span class="linenos">385</span></a><span class="sd">        &gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="DatasetBuilder-386"><a href="#DatasetBuilder-386"><span class="linenos">386</span></a><span class="sd">        &gt;&gt;&gt; builder.load_responses()</span>
</span><span id="DatasetBuilder-387"><a href="#DatasetBuilder-387"><span class="linenos">387</span></a>
</span><span id="DatasetBuilder-388"><a href="#DatasetBuilder-388"><span class="linenos">388</span></a><span class="sd">        --&gt;</span>
</span><span id="DatasetBuilder-389"><a href="#DatasetBuilder-389"><span class="linenos">389</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="DatasetBuilder-390"><a href="#DatasetBuilder-390"><span class="linenos">390</span></a><span class="sd">        &gt;&gt;&gt; builder.add_stimuli(Gammatone(</span>
</span><span id="DatasetBuilder-391"><a href="#DatasetBuilder-391"><span class="linenos">391</span></a><span class="sd">        ...     window_time=0.001,</span>
</span><span id="DatasetBuilder-392"><a href="#DatasetBuilder-392"><span class="linenos">392</span></a><span class="sd">        ...     frequency_bin_count=50,</span>
</span><span id="DatasetBuilder-393"><a href="#DatasetBuilder-393"><span class="linenos">393</span></a><span class="sd">        ...     min_frequency=500,</span>
</span><span id="DatasetBuilder-394"><a href="#DatasetBuilder-394"><span class="linenos">394</span></a><span class="sd">        ...     max_frequency=8000,</span>
</span><span id="DatasetBuilder-395"><a href="#DatasetBuilder-395"><span class="linenos">395</span></a><span class="sd">        ... ), time_step=0.005) # 5 ms</span>
</span><span id="DatasetBuilder-396"><a href="#DatasetBuilder-396"><span class="linenos">396</span></a>
</span><span id="DatasetBuilder-397"><a href="#DatasetBuilder-397"><span class="linenos">397</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-398"><a href="#DatasetBuilder-398"><span class="linenos">398</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli_format</span> <span class="o">=</span> <span class="n">stimuli_format</span>
</span><span id="DatasetBuilder-399"><a href="#DatasetBuilder-399"><span class="linenos">399</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli</span> <span class="o">=</span> <span class="n">stimuli_format</span><span class="o">.</span><span class="n">create_dataframe</span><span class="p">(</span>
</span><span id="DatasetBuilder-400"><a href="#DatasetBuilder-400"><span class="linenos">400</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
</span><span id="DatasetBuilder-401"><a href="#DatasetBuilder-401"><span class="linenos">401</span></a>            <span class="n">time_step</span><span class="p">,</span>
</span><span id="DatasetBuilder-402"><a href="#DatasetBuilder-402"><span class="linenos">402</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;stimulus.interval&quot;</span><span class="p">]]</span>
</span><span id="DatasetBuilder-403"><a href="#DatasetBuilder-403"><span class="linenos">403</span></a>            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</span><span id="DatasetBuilder-404"><a href="#DatasetBuilder-404"><span class="linenos">404</span></a>            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">)[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">],</span>
</span><span id="DatasetBuilder-405"><a href="#DatasetBuilder-405"><span class="linenos">405</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-406"><a href="#DatasetBuilder-406"><span class="linenos">406</span></a>        <span class="n">time_steps</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="DatasetBuilder-407"><a href="#DatasetBuilder-407"><span class="linenos">407</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
</span><span id="DatasetBuilder-408"><a href="#DatasetBuilder-408"><span class="linenos">408</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DatasetBuilder-409"><a href="#DatasetBuilder-409"><span class="linenos">409</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span><span id="DatasetBuilder-410"><a href="#DatasetBuilder-410"><span class="linenos">410</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-411"><a href="#DatasetBuilder-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">time_steps</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="DatasetBuilder-412"><a href="#DatasetBuilder-412"><span class="linenos">412</span></a>            <span class="k">raise</span> <span class="n">IncompatibleStimulusSamplingRates</span>
</span><span id="DatasetBuilder-413"><a href="#DatasetBuilder-413"><span class="linenos">413</span></a>
</span><span id="DatasetBuilder-414"><a href="#DatasetBuilder-414"><span class="linenos">414</span></a>    <span class="k">def</span> <span class="nf">create_time_lags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.300</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Basis</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="DatasetBuilder-415"><a href="#DatasetBuilder-415"><span class="linenos">415</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-416"><a href="#DatasetBuilder-416"><span class="linenos">416</span></a><span class="sd">        `tau`: length of window (in secs) to consider in prediction</span>
</span><span id="DatasetBuilder-417"><a href="#DatasetBuilder-417"><span class="linenos">417</span></a><span class="sd">        `basis`: an instance of a class that inherits from</span>
</span><span id="DatasetBuilder-418"><a href="#DatasetBuilder-418"><span class="linenos">418</span></a><span class="sd">        `preconstruct.basisfunctions.Basis`, initialized with the dimension</span>
</span><span id="DatasetBuilder-419"><a href="#DatasetBuilder-419"><span class="linenos">419</span></a><span class="sd">        of the projection</span>
</span><span id="DatasetBuilder-420"><a href="#DatasetBuilder-420"><span class="linenos">420</span></a>
</span><span id="DatasetBuilder-421"><a href="#DatasetBuilder-421"><span class="linenos">421</span></a><span class="sd">        ###### example</span>
</span><span id="DatasetBuilder-422"><a href="#DatasetBuilder-422"><span class="linenos">422</span></a><span class="sd">        &lt;!--</span>
</span><span id="DatasetBuilder-423"><a href="#DatasetBuilder-423"><span class="linenos">423</span></a><span class="sd">        &gt;&gt;&gt; import asyncio</span>
</span><span id="DatasetBuilder-424"><a href="#DatasetBuilder-424"><span class="linenos">424</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="DatasetBuilder-425"><a href="#DatasetBuilder-425"><span class="linenos">425</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="DatasetBuilder-426"><a href="#DatasetBuilder-426"><span class="linenos">426</span></a><span class="sd">        &gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;]</span>
</span><span id="DatasetBuilder-427"><a href="#DatasetBuilder-427"><span class="linenos">427</span></a><span class="sd">        &gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="DatasetBuilder-428"><a href="#DatasetBuilder-428"><span class="linenos">428</span></a><span class="sd">        &gt;&gt;&gt; stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;,</span>
</span><span id="DatasetBuilder-429"><a href="#DatasetBuilder-429"><span class="linenos">429</span></a><span class="sd">        ...         &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="DatasetBuilder-430"><a href="#DatasetBuilder-430"><span class="linenos">430</span></a><span class="sd">        &gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="DatasetBuilder-431"><a href="#DatasetBuilder-431"><span class="linenos">431</span></a><span class="sd">        &gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="DatasetBuilder-432"><a href="#DatasetBuilder-432"><span class="linenos">432</span></a><span class="sd">        &gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="DatasetBuilder-433"><a href="#DatasetBuilder-433"><span class="linenos">433</span></a><span class="sd">        &gt;&gt;&gt; builder.load_responses()</span>
</span><span id="DatasetBuilder-434"><a href="#DatasetBuilder-434"><span class="linenos">434</span></a><span class="sd">        &gt;&gt;&gt; builder.bin_responses(time_step=0.005) # 5 ms</span>
</span><span id="DatasetBuilder-435"><a href="#DatasetBuilder-435"><span class="linenos">435</span></a><span class="sd">        &gt;&gt;&gt; builder.add_stimuli(Gammatone())</span>
</span><span id="DatasetBuilder-436"><a href="#DatasetBuilder-436"><span class="linenos">436</span></a>
</span><span id="DatasetBuilder-437"><a href="#DatasetBuilder-437"><span class="linenos">437</span></a>
</span><span id="DatasetBuilder-438"><a href="#DatasetBuilder-438"><span class="linenos">438</span></a><span class="sd">        --&gt;</span>
</span><span id="DatasetBuilder-439"><a href="#DatasetBuilder-439"><span class="linenos">439</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.basisfunctions import RaisedCosineBasis</span>
</span><span id="DatasetBuilder-440"><a href="#DatasetBuilder-440"><span class="linenos">440</span></a><span class="sd">        &gt;&gt;&gt; builder.create_time_lags(tau=0.3, basis=RaisedCosineBasis(30))</span>
</span><span id="DatasetBuilder-441"><a href="#DatasetBuilder-441"><span class="linenos">441</span></a>
</span><span id="DatasetBuilder-442"><a href="#DatasetBuilder-442"><span class="linenos">442</span></a>
</span><span id="DatasetBuilder-443"><a href="#DatasetBuilder-443"><span class="linenos">443</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-444"><a href="#DatasetBuilder-444"><span class="linenos">444</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
</span><span id="DatasetBuilder-445"><a href="#DatasetBuilder-445"><span class="linenos">445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DatasetBuilder-446"><a href="#DatasetBuilder-446"><span class="linenos">446</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DatasetBuilder-447"><a href="#DatasetBuilder-447"><span class="linenos">447</span></a>            <span class="n">window_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">to_steps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
</span><span id="DatasetBuilder-448"><a href="#DatasetBuilder-448"><span class="linenos">448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">get_basis</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span>
</span><span id="DatasetBuilder-449"><a href="#DatasetBuilder-449"><span class="linenos">449</span></a>        <span class="c1"># figure out if trials have been pooled and adjust accordingly</span>
</span><span id="DatasetBuilder-450"><a href="#DatasetBuilder-450"><span class="linenos">450</span></a>        <span class="n">common_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DatasetBuilder-451"><a href="#DatasetBuilder-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="DatasetBuilder-452"><a href="#DatasetBuilder-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span>
</span><span id="DatasetBuilder-453"><a href="#DatasetBuilder-453"><span class="linenos">453</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="DatasetBuilder-454"><a href="#DatasetBuilder-454"><span class="linenos">454</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="DatasetBuilder-455"><a href="#DatasetBuilder-455"><span class="linenos">455</span></a>                <span class="k">lambda</span> <span class="n">neuron</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[</span>
</span><span id="DatasetBuilder-456"><a href="#DatasetBuilder-456"><span class="linenos">456</span></a>                    <span class="p">[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">,</span> <span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder-457"><a href="#DatasetBuilder-457"><span class="linenos">457</span></a>                <span class="p">]</span>
</span><span id="DatasetBuilder-458"><a href="#DatasetBuilder-458"><span class="linenos">458</span></a>                <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="DatasetBuilder-459"><a href="#DatasetBuilder-459"><span class="linenos">459</span></a>                    <span class="n">neuron</span><span class="p">[</span><span class="n">neuron</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># convert to series</span>
</span><span id="DatasetBuilder-460"><a href="#DatasetBuilder-460"><span class="linenos">460</span></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder-461"><a href="#DatasetBuilder-461"><span class="linenos">461</span></a>                    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
</span><span id="DatasetBuilder-462"><a href="#DatasetBuilder-462"><span class="linenos">462</span></a>                    <span class="n">on</span><span class="o">=</span><span class="n">common_index</span><span class="p">,</span>
</span><span id="DatasetBuilder-463"><a href="#DatasetBuilder-463"><span class="linenos">463</span></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="DatasetBuilder-464"><a href="#DatasetBuilder-464"><span class="linenos">464</span></a>                <span class="p">)</span>
</span><span id="DatasetBuilder-465"><a href="#DatasetBuilder-465"><span class="linenos">465</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="DatasetBuilder-466"><a href="#DatasetBuilder-466"><span class="linenos">466</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_stimuli</span><span class="p">()</span>
</span><span id="DatasetBuilder-467"><a href="#DatasetBuilder-467"><span class="linenos">467</span></a>                    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DatasetBuilder-468"><a href="#DatasetBuilder-468"><span class="linenos">468</span></a>                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DatasetBuilder-469"><a href="#DatasetBuilder-469"><span class="linenos">469</span></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;stimulus.length&quot;</span><span class="p">),</span>
</span><span id="DatasetBuilder-470"><a href="#DatasetBuilder-470"><span class="linenos">470</span></a>                    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span>
</span><span id="DatasetBuilder-471"><a href="#DatasetBuilder-471"><span class="linenos">471</span></a>                <span class="p">)</span>
</span><span id="DatasetBuilder-472"><a href="#DatasetBuilder-472"><span class="linenos">472</span></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">common_index</span><span class="p">)</span>
</span><span id="DatasetBuilder-473"><a href="#DatasetBuilder-473"><span class="linenos">473</span></a>                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stagger</span><span class="p">)</span>
</span><span id="DatasetBuilder-474"><a href="#DatasetBuilder-474"><span class="linenos">474</span></a>            <span class="p">)</span>
</span><span id="DatasetBuilder-475"><a href="#DatasetBuilder-475"><span class="linenos">475</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-476"><a href="#DatasetBuilder-476"><span class="linenos">476</span></a>
</span><span id="DatasetBuilder-477"><a href="#DatasetBuilder-477"><span class="linenos">477</span></a>    <span class="k">def</span> <span class="nf">_stagger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
</span><span id="DatasetBuilder-478"><a href="#DatasetBuilder-478"><span class="linenos">478</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="DatasetBuilder-479"><a href="#DatasetBuilder-479"><span class="linenos">479</span></a>        <span class="p">[</span><span class="n">stimulus_interval</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="DatasetBuilder-480"><a href="#DatasetBuilder-480"><span class="linenos">480</span></a>        <span class="n">stim_start</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stimulus_interval</span>
</span><span id="DatasetBuilder-481"><a href="#DatasetBuilder-481"><span class="linenos">481</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">stim_start</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
</span><span id="DatasetBuilder-482"><a href="#DatasetBuilder-482"><span class="linenos">482</span></a>        <span class="n">window_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">to_steps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
</span><span id="DatasetBuilder-483"><a href="#DatasetBuilder-483"><span class="linenos">483</span></a>        <span class="p">[</span><span class="n">stimulus_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stimulus.length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="DatasetBuilder-484"><a href="#DatasetBuilder-484"><span class="linenos">484</span></a>        <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">stimulus_length</span>
</span><span id="DatasetBuilder-485"><a href="#DatasetBuilder-485"><span class="linenos">485</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder-486"><a href="#DatasetBuilder-486"><span class="linenos">486</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">window_length</span>
</span><span id="DatasetBuilder-487"><a href="#DatasetBuilder-487"><span class="linenos">487</span></a>        <span class="n">time_lagged</span> <span class="o">=</span> <span class="n">hankel</span><span class="p">(</span>
</span><span id="DatasetBuilder-488"><a href="#DatasetBuilder-488"><span class="linenos">488</span></a>            <span class="n">events</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">events</span><span class="p">[</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">window_length</span><span class="p">]</span>
</span><span id="DatasetBuilder-489"><a href="#DatasetBuilder-489"><span class="linenos">489</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-490"><a href="#DatasetBuilder-490"><span class="linenos">490</span></a>        <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
</span><span id="DatasetBuilder-491"><a href="#DatasetBuilder-491"><span class="linenos">491</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_time_step</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;offset&quot;</span>
</span><span id="DatasetBuilder-492"><a href="#DatasetBuilder-492"><span class="linenos">492</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-493"><a href="#DatasetBuilder-493"><span class="linenos">493</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DatasetBuilder-494"><a href="#DatasetBuilder-494"><span class="linenos">494</span></a>            <span class="n">time_lagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">time_lagged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span><span class="p">)</span>
</span><span id="DatasetBuilder-495"><a href="#DatasetBuilder-495"><span class="linenos">495</span></a>            <span class="n">columns</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DatasetBuilder-496"><a href="#DatasetBuilder-496"><span class="linenos">496</span></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="DatasetBuilder-497"><a href="#DatasetBuilder-497"><span class="linenos">497</span></a>            <span class="n">time_lagged</span><span class="p">,</span>
</span><span id="DatasetBuilder-498"><a href="#DatasetBuilder-498"><span class="linenos">498</span></a>            <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span>
</span><span id="DatasetBuilder-499"><a href="#DatasetBuilder-499"><span class="linenos">499</span></a>            <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
</span><span id="DatasetBuilder-500"><a href="#DatasetBuilder-500"><span class="linenos">500</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-501"><a href="#DatasetBuilder-501"><span class="linenos">501</span></a>
</span><span id="DatasetBuilder-502"><a href="#DatasetBuilder-502"><span class="linenos">502</span></a>    <span class="k">def</span> <span class="nf">pool_trials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DatasetBuilder-503"><a href="#DatasetBuilder-503"><span class="linenos">503</span></a>        <span class="sd">&quot;&quot;&quot;Pool spikes across trials&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-504"><a href="#DatasetBuilder-504"><span class="linenos">504</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="DatasetBuilder-505"><a href="#DatasetBuilder-505"><span class="linenos">505</span></a>            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()</span>
</span><span id="DatasetBuilder-506"><a href="#DatasetBuilder-506"><span class="linenos">506</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">)[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder-507"><a href="#DatasetBuilder-507"><span class="linenos">507</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ser</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="DatasetBuilder-508"><a href="#DatasetBuilder-508"><span class="linenos">508</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="DatasetBuilder-509"><a href="#DatasetBuilder-509"><span class="linenos">509</span></a>        <span class="p">):</span>
</span><span id="DatasetBuilder-510"><a href="#DatasetBuilder-510"><span class="linenos">510</span></a>            <span class="k">raise</span> <span class="n">InconsistentStimulusInterval</span>
</span><span id="DatasetBuilder-511"><a href="#DatasetBuilder-511"><span class="linenos">511</span></a>
</span><span id="DatasetBuilder-512"><a href="#DatasetBuilder-512"><span class="linenos">512</span></a>        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="DatasetBuilder-513"><a href="#DatasetBuilder-513"><span class="linenos">513</span></a>        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="DatasetBuilder-514"><a href="#DatasetBuilder-514"><span class="linenos">514</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;bin_responses&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder-515"><a href="#DatasetBuilder-515"><span class="linenos">515</span></a>        <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
</span><span id="DatasetBuilder-516"><a href="#DatasetBuilder-516"><span class="linenos">516</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder-517"><a href="#DatasetBuilder-517"><span class="linenos">517</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-518"><a href="#DatasetBuilder-518"><span class="linenos">518</span></a>        <span class="k">del</span> <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder-519"><a href="#DatasetBuilder-519"><span class="linenos">519</span></a>        <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</span><span id="DatasetBuilder-520"><a href="#DatasetBuilder-520"><span class="linenos">520</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span><span id="DatasetBuilder-521"><a href="#DatasetBuilder-521"><span class="linenos">521</span></a>            <span class="s2">&quot;sum&quot;</span>
</span><span id="DatasetBuilder-522"><a href="#DatasetBuilder-522"><span class="linenos">522</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder-523"><a href="#DatasetBuilder-523"><span class="linenos">523</span></a>
</span><span id="DatasetBuilder-524"><a href="#DatasetBuilder-524"><span class="linenos">524</span></a>    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
</span><span id="DatasetBuilder-525"><a href="#DatasetBuilder-525"><span class="linenos">525</span></a>        <span class="sd">&quot;&quot;&quot;Return the fully constructed `Dataset` object&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder-526"><a href="#DatasetBuilder-526"><span class="linenos">526</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span>
</span></pre></div>


            <div class="docstring"><p>Construct instances of the <code><a href="#Dataset">Dataset</a></code> class using the <a href="https://refactoring.guru/design-patterns/builder">builder
pattern</a></p>
</div>


                            <div id="DatasetBuilder.__init__" class="classattr">
                                        <input id="DatasetBuilder.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DatasetBuilder</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="DatasetBuilder.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder.__init__-271"><a href="#DatasetBuilder.__init__-271"><span class="linenos">271</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DatasetBuilder.__init__-272"><a href="#DatasetBuilder.__init__-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
</span><span id="DatasetBuilder.__init__-273"><a href="#DatasetBuilder.__init__-273"><span class="linenos">273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">_EmptySource</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="DatasetBuilder.set_data_source" class="classattr">
                                        <input id="DatasetBuilder.set_data_source-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_data_source</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data_source</span><span class="p">:</span> <span class="n"><a href="sources.html#DataSource">preconstruct.sources.DataSource</a></span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DatasetBuilder.set_data_source-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder.set_data_source"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder.set_data_source-275"><a href="#DatasetBuilder.set_data_source-275"><span class="linenos">275</span></a>    <span class="k">def</span> <span class="nf">set_data_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_source</span><span class="p">:</span> <span class="n">DataSource</span><span class="p">):</span>
</span><span id="DatasetBuilder.set_data_source-276"><a href="#DatasetBuilder.set_data_source-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span>
</span></pre></div>


    

                            </div>
                            <div id="DatasetBuilder.load_responses" class="classattr">
                                        <input id="DatasetBuilder.load_responses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_responses</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ignore_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DatasetBuilder.load_responses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder.load_responses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder.load_responses-278"><a href="#DatasetBuilder.load_responses-278"><span class="linenos">278</span></a>    <span class="k">def</span> <span class="nf">load_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="DatasetBuilder.load_responses-279"><a href="#DatasetBuilder.load_responses-279"><span class="linenos">279</span></a>        <span class="k">if</span> <span class="n">ignore_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DatasetBuilder.load_responses-280"><a href="#DatasetBuilder.load_responses-280"><span class="linenos">280</span></a>            <span class="n">ignore_columns</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DatasetBuilder.load_responses-281"><a href="#DatasetBuilder.load_responses-281"><span class="linenos">281</span></a>        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="o">.</span><span class="n">get_responses</span><span class="p">()</span>
</span><span id="DatasetBuilder.load_responses-282"><a href="#DatasetBuilder.load_responses-282"><span class="linenos">282</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;no clusters&quot;</span>
</span><span id="DatasetBuilder.load_responses-283"><a href="#DatasetBuilder.load_responses-283"><span class="linenos">283</span></a>        <span class="n">trial_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="DatasetBuilder.load_responses-284"><a href="#DatasetBuilder.load_responses-284"><span class="linenos">284</span></a>            <span class="p">{</span>
</span><span id="DatasetBuilder.load_responses-285"><a href="#DatasetBuilder.load_responses-285"><span class="linenos">285</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;pprox&quot;</span><span class="p">])</span>
</span><span id="DatasetBuilder.load_responses-286"><a href="#DatasetBuilder.load_responses-286"><span class="linenos">286</span></a>                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;trial&quot;</span><span class="p">})</span>
</span><span id="DatasetBuilder.load_responses-287"><a href="#DatasetBuilder.load_responses-287"><span class="linenos">287</span></a>                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;trial&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder.load_responses-288"><a href="#DatasetBuilder.load_responses-288"><span class="linenos">288</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="DatasetBuilder.load_responses-289"><a href="#DatasetBuilder.load_responses-289"><span class="linenos">289</span></a>            <span class="p">},</span>
</span><span id="DatasetBuilder.load_responses-290"><a href="#DatasetBuilder.load_responses-290"><span class="linenos">290</span></a>            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="DatasetBuilder.load_responses-291"><a href="#DatasetBuilder.load_responses-291"><span class="linenos">291</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder.load_responses-292"><a href="#DatasetBuilder.load_responses-292"><span class="linenos">292</span></a>        <span class="n">trial_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="DatasetBuilder.load_responses-293"><a href="#DatasetBuilder.load_responses-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;neuron&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder.load_responses-294"><a href="#DatasetBuilder.load_responses-294"><span class="linenos">294</span></a>        <span class="n">ignore_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder.load_responses-295"><a href="#DatasetBuilder.load_responses-295"><span class="linenos">295</span></a>        <span class="n">trial_data</span> <span class="o">=</span> <span class="n">trial_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">ignore_columns</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DatasetBuilder.load_responses-296"><a href="#DatasetBuilder.load_responses-296"><span class="linenos">296</span></a>        <span class="n">single_trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_trials</span><span class="p">(</span><span class="n">trial_data</span><span class="p">)</span>
</span><span id="DatasetBuilder.load_responses-297"><a href="#DatasetBuilder.load_responses-297"><span class="linenos">297</span></a>        <span class="k">assert</span> <span class="n">single_trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="DatasetBuilder.load_responses-298"><a href="#DatasetBuilder.load_responses-298"><span class="linenos">298</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">trial_data</span> <span class="o">=</span> <span class="n">single_trial</span>
</span><span id="DatasetBuilder.load_responses-299"><a href="#DatasetBuilder.load_responses-299"><span class="linenos">299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">trial_data</span> <span class="o">=</span> <span class="n">trial_data</span>
</span></pre></div>


    

                            </div>
                            <div id="DatasetBuilder.bin_responses" class="classattr">
                                        <input id="DatasetBuilder.bin_responses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bin_responses</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DatasetBuilder.bin_responses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder.bin_responses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder.bin_responses-325"><a href="#DatasetBuilder.bin_responses-325"><span class="linenos">325</span></a>    <span class="k">def</span> <span class="nf">bin_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span><span id="DatasetBuilder.bin_responses-326"><a href="#DatasetBuilder.bin_responses-326"><span class="linenos">326</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder.bin_responses-327"><a href="#DatasetBuilder.bin_responses-327"><span class="linenos">327</span></a><span class="sd">        transform a point process into bins containing the number of events (or if `normalize` </span>
</span><span id="DatasetBuilder.bin_responses-328"><a href="#DatasetBuilder.bin_responses-328"><span class="linenos">328</span></a><span class="sd">        is True, the rate of events) that occurred within the time bin. Time bins are set based on</span>
</span><span id="DatasetBuilder.bin_responses-329"><a href="#DatasetBuilder.bin_responses-329"><span class="linenos">329</span></a><span class="sd">        the stimulus, so this has to be called after add_stimuli()</span>
</span><span id="DatasetBuilder.bin_responses-330"><a href="#DatasetBuilder.bin_responses-330"><span class="linenos">330</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder.bin_responses-331"><a href="#DatasetBuilder.bin_responses-331"><span class="linenos">331</span></a>        <span class="n">trials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()</span>
</span><span id="DatasetBuilder.bin_responses-332"><a href="#DatasetBuilder.bin_responses-332"><span class="linenos">332</span></a>        <span class="n">spike_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span>
</span><span id="DatasetBuilder.bin_responses-333"><a href="#DatasetBuilder.bin_responses-333"><span class="linenos">333</span></a>        <span class="n">stimuli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_stimuli</span><span class="p">()</span>
</span><span id="DatasetBuilder.bin_responses-334"><a href="#DatasetBuilder.bin_responses-334"><span class="linenos">334</span></a>
</span><span id="DatasetBuilder.bin_responses-335"><a href="#DatasetBuilder.bin_responses-335"><span class="linenos">335</span></a>        <span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span><span id="DatasetBuilder.bin_responses-336"><a href="#DatasetBuilder.bin_responses-336"><span class="linenos">336</span></a>            <span class="n">stim_name</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder.bin_responses-337"><a href="#DatasetBuilder.bin_responses-337"><span class="linenos">337</span></a>            <span class="n">interval</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;interval&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder.bin_responses-338"><a href="#DatasetBuilder.bin_responses-338"><span class="linenos">338</span></a>            <span class="n">stim_bins</span> <span class="o">=</span> <span class="n">stimuli</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="DatasetBuilder.bin_responses-339"><a href="#DatasetBuilder.bin_responses-339"><span class="linenos">339</span></a>            <span class="n">time_step</span> <span class="o">=</span> <span class="n">stim_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">stim_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DatasetBuilder.bin_responses-340"><a href="#DatasetBuilder.bin_responses-340"><span class="linenos">340</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
</span><span id="DatasetBuilder.bin_responses-341"><a href="#DatasetBuilder.bin_responses-341"><span class="linenos">341</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_step</span><span class="p">,</span> <span class="o">-</span><span class="n">time_step</span><span class="p">)[:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="DatasetBuilder.bin_responses-342"><a href="#DatasetBuilder.bin_responses-342"><span class="linenos">342</span></a>                <span class="n">stim_bins</span><span class="p">,</span>
</span><span id="DatasetBuilder.bin_responses-343"><a href="#DatasetBuilder.bin_responses-343"><span class="linenos">343</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stim_bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">time_step</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="DatasetBuilder.bin_responses-344"><a href="#DatasetBuilder.bin_responses-344"><span class="linenos">344</span></a>            <span class="p">])</span>
</span><span id="DatasetBuilder.bin_responses-345"><a href="#DatasetBuilder.bin_responses-345"><span class="linenos">345</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">(</span>
</span><span id="DatasetBuilder.bin_responses-346"><a href="#DatasetBuilder.bin_responses-346"><span class="linenos">346</span></a>                <span class="n">df</span><span class="p">[</span><span class="n">spike_times</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="DatasetBuilder.bin_responses-347"><a href="#DatasetBuilder.bin_responses-347"><span class="linenos">347</span></a>                <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="DatasetBuilder.bin_responses-348"><a href="#DatasetBuilder.bin_responses-348"><span class="linenos">348</span></a>                    <span class="k">lambda</span> <span class="n">spikes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="DatasetBuilder.bin_responses-349"><a href="#DatasetBuilder.bin_responses-349"><span class="linenos">349</span></a>                <span class="p">)</span>
</span><span id="DatasetBuilder.bin_responses-350"><a href="#DatasetBuilder.bin_responses-350"><span class="linenos">350</span></a>                <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="DatasetBuilder.bin_responses-351"><a href="#DatasetBuilder.bin_responses-351"><span class="linenos">351</span></a>                <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="DatasetBuilder.bin_responses-352"><a href="#DatasetBuilder.bin_responses-352"><span class="linenos">352</span></a>            <span class="p">)</span>
</span><span id="DatasetBuilder.bin_responses-353"><a href="#DatasetBuilder.bin_responses-353"><span class="linenos">353</span></a>            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
</span><span id="DatasetBuilder.bin_responses-354"><a href="#DatasetBuilder.bin_responses-354"><span class="linenos">354</span></a>                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">/</span> <span class="n">time_step</span>
</span><span id="DatasetBuilder.bin_responses-355"><a href="#DatasetBuilder.bin_responses-355"><span class="linenos">355</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="DatasetBuilder.bin_responses-356"><a href="#DatasetBuilder.bin_responses-356"><span class="linenos">356</span></a>                <span class="n">arr</span><span class="p">,</span>
</span><span id="DatasetBuilder.bin_responses-357"><a href="#DatasetBuilder.bin_responses-357"><span class="linenos">357</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
</span><span id="DatasetBuilder.bin_responses-358"><a href="#DatasetBuilder.bin_responses-358"><span class="linenos">358</span></a>                    <span class="p">[[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder.bin_responses-359"><a href="#DatasetBuilder.bin_responses-359"><span class="linenos">359</span></a>                <span class="p">),</span>
</span><span id="DatasetBuilder.bin_responses-360"><a href="#DatasetBuilder.bin_responses-360"><span class="linenos">360</span></a>                <span class="n">columns</span><span class="o">=</span><span class="n">spike_times</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
</span><span id="DatasetBuilder.bin_responses-361"><a href="#DatasetBuilder.bin_responses-361"><span class="linenos">361</span></a>            <span class="p">)</span>
</span><span id="DatasetBuilder.bin_responses-362"><a href="#DatasetBuilder.bin_responses-362"><span class="linenos">362</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="DatasetBuilder.bin_responses-363"><a href="#DatasetBuilder.bin_responses-363"><span class="linenos">363</span></a>            <span class="p">[</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">spike_times</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
</span><span id="DatasetBuilder.bin_responses-364"><a href="#DatasetBuilder.bin_responses-364"><span class="linenos">364</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>transform a point process into bins containing the number of events (or if <code>normalize</code> 
is True, the rate of events) that occurred within the time bin. Time bins are set based on
the stimulus, so this has to be called after add_stimuli()</p>
</div>


                            </div>
                            <div id="DatasetBuilder.add_stimuli" class="classattr">
                                        <input id="DatasetBuilder.add_stimuli-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_stimuli</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">stimuli_format</span><span class="p">:</span> <span class="n"><a href="stimuliformats.html#StimuliFormat">preconstruct.stimuliformats.StimuliFormat</a></span>,</span><span class="param">	<span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DatasetBuilder.add_stimuli-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder.add_stimuli"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder.add_stimuli-366"><a href="#DatasetBuilder.add_stimuli-366"><span class="linenos">366</span></a>    <span class="k">def</span> <span class="nf">add_stimuli</span><span class="p">(</span>
</span><span id="DatasetBuilder.add_stimuli-367"><a href="#DatasetBuilder.add_stimuli-367"><span class="linenos">367</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">stimuli_format</span><span class="p">:</span> <span class="n">StimuliFormat</span><span class="p">,</span> <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="DatasetBuilder.add_stimuli-368"><a href="#DatasetBuilder.add_stimuli-368"><span class="linenos">368</span></a>    <span class="p">):</span>
</span><span id="DatasetBuilder.add_stimuli-369"><a href="#DatasetBuilder.add_stimuli-369"><span class="linenos">369</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder.add_stimuli-370"><a href="#DatasetBuilder.add_stimuli-370"><span class="linenos">370</span></a><span class="sd">        Add a dataframe containing formatted stimuli for each</span>
</span><span id="DatasetBuilder.add_stimuli-371"><a href="#DatasetBuilder.add_stimuli-371"><span class="linenos">371</span></a><span class="sd">        stimulus associated with a trial</span>
</span><span id="DatasetBuilder.add_stimuli-372"><a href="#DatasetBuilder.add_stimuli-372"><span class="linenos">372</span></a>
</span><span id="DatasetBuilder.add_stimuli-373"><a href="#DatasetBuilder.add_stimuli-373"><span class="linenos">373</span></a><span class="sd">        Consult documentation for `preconstruct.stimuliformats` for details.</span>
</span><span id="DatasetBuilder.add_stimuli-374"><a href="#DatasetBuilder.add_stimuli-374"><span class="linenos">374</span></a>
</span><span id="DatasetBuilder.add_stimuli-375"><a href="#DatasetBuilder.add_stimuli-375"><span class="linenos">375</span></a><span class="sd">        ###### example</span>
</span><span id="DatasetBuilder.add_stimuli-376"><a href="#DatasetBuilder.add_stimuli-376"><span class="linenos">376</span></a><span class="sd">        &lt;!--</span>
</span><span id="DatasetBuilder.add_stimuli-377"><a href="#DatasetBuilder.add_stimuli-377"><span class="linenos">377</span></a><span class="sd">        &gt;&gt;&gt; import asyncio</span>
</span><span id="DatasetBuilder.add_stimuli-378"><a href="#DatasetBuilder.add_stimuli-378"><span class="linenos">378</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="DatasetBuilder.add_stimuli-379"><a href="#DatasetBuilder.add_stimuli-379"><span class="linenos">379</span></a><span class="sd">        &gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;]</span>
</span><span id="DatasetBuilder.add_stimuli-380"><a href="#DatasetBuilder.add_stimuli-380"><span class="linenos">380</span></a><span class="sd">        &gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="DatasetBuilder.add_stimuli-381"><a href="#DatasetBuilder.add_stimuli-381"><span class="linenos">381</span></a><span class="sd">        &gt;&gt;&gt; stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;,</span>
</span><span id="DatasetBuilder.add_stimuli-382"><a href="#DatasetBuilder.add_stimuli-382"><span class="linenos">382</span></a><span class="sd">        ...         &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="DatasetBuilder.add_stimuli-383"><a href="#DatasetBuilder.add_stimuli-383"><span class="linenos">383</span></a><span class="sd">        &gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="DatasetBuilder.add_stimuli-384"><a href="#DatasetBuilder.add_stimuli-384"><span class="linenos">384</span></a><span class="sd">        &gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="DatasetBuilder.add_stimuli-385"><a href="#DatasetBuilder.add_stimuli-385"><span class="linenos">385</span></a><span class="sd">        &gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="DatasetBuilder.add_stimuli-386"><a href="#DatasetBuilder.add_stimuli-386"><span class="linenos">386</span></a><span class="sd">        &gt;&gt;&gt; builder.load_responses()</span>
</span><span id="DatasetBuilder.add_stimuli-387"><a href="#DatasetBuilder.add_stimuli-387"><span class="linenos">387</span></a>
</span><span id="DatasetBuilder.add_stimuli-388"><a href="#DatasetBuilder.add_stimuli-388"><span class="linenos">388</span></a><span class="sd">        --&gt;</span>
</span><span id="DatasetBuilder.add_stimuli-389"><a href="#DatasetBuilder.add_stimuli-389"><span class="linenos">389</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="DatasetBuilder.add_stimuli-390"><a href="#DatasetBuilder.add_stimuli-390"><span class="linenos">390</span></a><span class="sd">        &gt;&gt;&gt; builder.add_stimuli(Gammatone(</span>
</span><span id="DatasetBuilder.add_stimuli-391"><a href="#DatasetBuilder.add_stimuli-391"><span class="linenos">391</span></a><span class="sd">        ...     window_time=0.001,</span>
</span><span id="DatasetBuilder.add_stimuli-392"><a href="#DatasetBuilder.add_stimuli-392"><span class="linenos">392</span></a><span class="sd">        ...     frequency_bin_count=50,</span>
</span><span id="DatasetBuilder.add_stimuli-393"><a href="#DatasetBuilder.add_stimuli-393"><span class="linenos">393</span></a><span class="sd">        ...     min_frequency=500,</span>
</span><span id="DatasetBuilder.add_stimuli-394"><a href="#DatasetBuilder.add_stimuli-394"><span class="linenos">394</span></a><span class="sd">        ...     max_frequency=8000,</span>
</span><span id="DatasetBuilder.add_stimuli-395"><a href="#DatasetBuilder.add_stimuli-395"><span class="linenos">395</span></a><span class="sd">        ... ), time_step=0.005) # 5 ms</span>
</span><span id="DatasetBuilder.add_stimuli-396"><a href="#DatasetBuilder.add_stimuli-396"><span class="linenos">396</span></a>
</span><span id="DatasetBuilder.add_stimuli-397"><a href="#DatasetBuilder.add_stimuli-397"><span class="linenos">397</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder.add_stimuli-398"><a href="#DatasetBuilder.add_stimuli-398"><span class="linenos">398</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli_format</span> <span class="o">=</span> <span class="n">stimuli_format</span>
</span><span id="DatasetBuilder.add_stimuli-399"><a href="#DatasetBuilder.add_stimuli-399"><span class="linenos">399</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli</span> <span class="o">=</span> <span class="n">stimuli_format</span><span class="o">.</span><span class="n">create_dataframe</span><span class="p">(</span>
</span><span id="DatasetBuilder.add_stimuli-400"><a href="#DatasetBuilder.add_stimuli-400"><span class="linenos">400</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span>
</span><span id="DatasetBuilder.add_stimuli-401"><a href="#DatasetBuilder.add_stimuli-401"><span class="linenos">401</span></a>            <span class="n">time_step</span><span class="p">,</span>
</span><span id="DatasetBuilder.add_stimuli-402"><a href="#DatasetBuilder.add_stimuli-402"><span class="linenos">402</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;stimulus.interval&quot;</span><span class="p">]]</span>
</span><span id="DatasetBuilder.add_stimuli-403"><a href="#DatasetBuilder.add_stimuli-403"><span class="linenos">403</span></a>            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</span><span id="DatasetBuilder.add_stimuli-404"><a href="#DatasetBuilder.add_stimuli-404"><span class="linenos">404</span></a>            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">)[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">],</span>
</span><span id="DatasetBuilder.add_stimuli-405"><a href="#DatasetBuilder.add_stimuli-405"><span class="linenos">405</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder.add_stimuli-406"><a href="#DatasetBuilder.add_stimuli-406"><span class="linenos">406</span></a>        <span class="n">time_steps</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="DatasetBuilder.add_stimuli-407"><a href="#DatasetBuilder.add_stimuli-407"><span class="linenos">407</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">stimuli</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
</span><span id="DatasetBuilder.add_stimuli-408"><a href="#DatasetBuilder.add_stimuli-408"><span class="linenos">408</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DatasetBuilder.add_stimuli-409"><a href="#DatasetBuilder.add_stimuli-409"><span class="linenos">409</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span><span id="DatasetBuilder.add_stimuli-410"><a href="#DatasetBuilder.add_stimuli-410"><span class="linenos">410</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder.add_stimuli-411"><a href="#DatasetBuilder.add_stimuli-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">time_steps</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="DatasetBuilder.add_stimuli-412"><a href="#DatasetBuilder.add_stimuli-412"><span class="linenos">412</span></a>            <span class="k">raise</span> <span class="n">IncompatibleStimulusSamplingRates</span>
</span></pre></div>


            <div class="docstring"><p>Add a dataframe containing formatted stimuli for each
stimulus associated with a trial</p>

<p>Consult documentation for <code><a href="stimuliformats.html">preconstruct.stimuliformats</a></code> for details.</p>

<h6 id="example">example</h6>

<!--



md5-f1e7faf48404474a150a2eea7a66f501




-->

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn"><a href="stimuliformats.html">preconstruct.stimuliformats</a></span> <span class="kn">import</span> <span class="n">Gammatone</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span><span class="o">.</span><span class="n">add_stimuli</span><span class="p">(</span><span class="n">Gammatone</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">window_time</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">frequency_bin_count</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">min_frequency</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">max_frequency</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span>
<span class="gp">... </span><span class="p">),</span> <span class="n">time_step</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span> <span class="c1"># 5 ms</span>
</code></pre>
</div>
</div>


                            </div>
                            <div id="DatasetBuilder.create_time_lags" class="classattr">
                                        <input id="DatasetBuilder.create_time_lags-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_time_lags</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>,</span><span class="param">	<span class="n">basis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="basisfunctions.html#Basis">preconstruct.basisfunctions.Basis</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DatasetBuilder.create_time_lags-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder.create_time_lags"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder.create_time_lags-414"><a href="#DatasetBuilder.create_time_lags-414"><span class="linenos">414</span></a>    <span class="k">def</span> <span class="nf">create_time_lags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.300</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Basis</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="DatasetBuilder.create_time_lags-415"><a href="#DatasetBuilder.create_time_lags-415"><span class="linenos">415</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder.create_time_lags-416"><a href="#DatasetBuilder.create_time_lags-416"><span class="linenos">416</span></a><span class="sd">        `tau`: length of window (in secs) to consider in prediction</span>
</span><span id="DatasetBuilder.create_time_lags-417"><a href="#DatasetBuilder.create_time_lags-417"><span class="linenos">417</span></a><span class="sd">        `basis`: an instance of a class that inherits from</span>
</span><span id="DatasetBuilder.create_time_lags-418"><a href="#DatasetBuilder.create_time_lags-418"><span class="linenos">418</span></a><span class="sd">        `preconstruct.basisfunctions.Basis`, initialized with the dimension</span>
</span><span id="DatasetBuilder.create_time_lags-419"><a href="#DatasetBuilder.create_time_lags-419"><span class="linenos">419</span></a><span class="sd">        of the projection</span>
</span><span id="DatasetBuilder.create_time_lags-420"><a href="#DatasetBuilder.create_time_lags-420"><span class="linenos">420</span></a>
</span><span id="DatasetBuilder.create_time_lags-421"><a href="#DatasetBuilder.create_time_lags-421"><span class="linenos">421</span></a><span class="sd">        ###### example</span>
</span><span id="DatasetBuilder.create_time_lags-422"><a href="#DatasetBuilder.create_time_lags-422"><span class="linenos">422</span></a><span class="sd">        &lt;!--</span>
</span><span id="DatasetBuilder.create_time_lags-423"><a href="#DatasetBuilder.create_time_lags-423"><span class="linenos">423</span></a><span class="sd">        &gt;&gt;&gt; import asyncio</span>
</span><span id="DatasetBuilder.create_time_lags-424"><a href="#DatasetBuilder.create_time_lags-424"><span class="linenos">424</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.sources import NeurobankSource</span>
</span><span id="DatasetBuilder.create_time_lags-425"><a href="#DatasetBuilder.create_time_lags-425"><span class="linenos">425</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.stimuliformats import Gammatone</span>
</span><span id="DatasetBuilder.create_time_lags-426"><a href="#DatasetBuilder.create_time_lags-426"><span class="linenos">426</span></a><span class="sd">        &gt;&gt;&gt; responses = [&#39;P120_1_1_c92&#39;]</span>
</span><span id="DatasetBuilder.create_time_lags-427"><a href="#DatasetBuilder.create_time_lags-427"><span class="linenos">427</span></a><span class="sd">        &gt;&gt;&gt; url = &#39;https://gracula.psyc.virginia.edu/neurobank/&#39;</span>
</span><span id="DatasetBuilder.create_time_lags-428"><a href="#DatasetBuilder.create_time_lags-428"><span class="linenos">428</span></a><span class="sd">        &gt;&gt;&gt; stimuli = [&#39;c95zqjxq&#39;, &#39;g29wxi4q&#39;, &#39;igmi8fxa&#39;, &#39;jkexyrd5&#39;, &#39;l1a3ltpy&#39;,</span>
</span><span id="DatasetBuilder.create_time_lags-429"><a href="#DatasetBuilder.create_time_lags-429"><span class="linenos">429</span></a><span class="sd">        ...         &#39;mrel2o09&#39;, &#39;p1mrfhop&#39;, &#39;vekibwgj&#39;, &#39;w08e1crn&#39;, &#39;ztqee46x&#39;]</span>
</span><span id="DatasetBuilder.create_time_lags-430"><a href="#DatasetBuilder.create_time_lags-430"><span class="linenos">430</span></a><span class="sd">        &gt;&gt;&gt; data_source = asyncio.run(NeurobankSource.create(url, stimuli, responses))</span>
</span><span id="DatasetBuilder.create_time_lags-431"><a href="#DatasetBuilder.create_time_lags-431"><span class="linenos">431</span></a><span class="sd">        &gt;&gt;&gt; builder = DatasetBuilder()</span>
</span><span id="DatasetBuilder.create_time_lags-432"><a href="#DatasetBuilder.create_time_lags-432"><span class="linenos">432</span></a><span class="sd">        &gt;&gt;&gt; builder.set_data_source(data_source)</span>
</span><span id="DatasetBuilder.create_time_lags-433"><a href="#DatasetBuilder.create_time_lags-433"><span class="linenos">433</span></a><span class="sd">        &gt;&gt;&gt; builder.load_responses()</span>
</span><span id="DatasetBuilder.create_time_lags-434"><a href="#DatasetBuilder.create_time_lags-434"><span class="linenos">434</span></a><span class="sd">        &gt;&gt;&gt; builder.bin_responses(time_step=0.005) # 5 ms</span>
</span><span id="DatasetBuilder.create_time_lags-435"><a href="#DatasetBuilder.create_time_lags-435"><span class="linenos">435</span></a><span class="sd">        &gt;&gt;&gt; builder.add_stimuli(Gammatone())</span>
</span><span id="DatasetBuilder.create_time_lags-436"><a href="#DatasetBuilder.create_time_lags-436"><span class="linenos">436</span></a>
</span><span id="DatasetBuilder.create_time_lags-437"><a href="#DatasetBuilder.create_time_lags-437"><span class="linenos">437</span></a>
</span><span id="DatasetBuilder.create_time_lags-438"><a href="#DatasetBuilder.create_time_lags-438"><span class="linenos">438</span></a><span class="sd">        --&gt;</span>
</span><span id="DatasetBuilder.create_time_lags-439"><a href="#DatasetBuilder.create_time_lags-439"><span class="linenos">439</span></a><span class="sd">        &gt;&gt;&gt; from preconstruct.basisfunctions import RaisedCosineBasis</span>
</span><span id="DatasetBuilder.create_time_lags-440"><a href="#DatasetBuilder.create_time_lags-440"><span class="linenos">440</span></a><span class="sd">        &gt;&gt;&gt; builder.create_time_lags(tau=0.3, basis=RaisedCosineBasis(30))</span>
</span><span id="DatasetBuilder.create_time_lags-441"><a href="#DatasetBuilder.create_time_lags-441"><span class="linenos">441</span></a>
</span><span id="DatasetBuilder.create_time_lags-442"><a href="#DatasetBuilder.create_time_lags-442"><span class="linenos">442</span></a>
</span><span id="DatasetBuilder.create_time_lags-443"><a href="#DatasetBuilder.create_time_lags-443"><span class="linenos">443</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DatasetBuilder.create_time_lags-444"><a href="#DatasetBuilder.create_time_lags-444"><span class="linenos">444</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
</span><span id="DatasetBuilder.create_time_lags-445"><a href="#DatasetBuilder.create_time_lags-445"><span class="linenos">445</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DatasetBuilder.create_time_lags-446"><a href="#DatasetBuilder.create_time_lags-446"><span class="linenos">446</span></a>        <span class="k">if</span> <span class="n">basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DatasetBuilder.create_time_lags-447"><a href="#DatasetBuilder.create_time_lags-447"><span class="linenos">447</span></a>            <span class="n">window_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">to_steps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-448"><a href="#DatasetBuilder.create_time_lags-448"><span class="linenos">448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">get_basis</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-449"><a href="#DatasetBuilder.create_time_lags-449"><span class="linenos">449</span></a>        <span class="c1"># figure out if trials have been pooled and adjust accordingly</span>
</span><span id="DatasetBuilder.create_time_lags-450"><a href="#DatasetBuilder.create_time_lags-450"><span class="linenos">450</span></a>        <span class="n">common_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DatasetBuilder.create_time_lags-451"><a href="#DatasetBuilder.create_time_lags-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="DatasetBuilder.create_time_lags-452"><a href="#DatasetBuilder.create_time_lags-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span>
</span><span id="DatasetBuilder.create_time_lags-453"><a href="#DatasetBuilder.create_time_lags-453"><span class="linenos">453</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-454"><a href="#DatasetBuilder.create_time_lags-454"><span class="linenos">454</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="DatasetBuilder.create_time_lags-455"><a href="#DatasetBuilder.create_time_lags-455"><span class="linenos">455</span></a>                <span class="k">lambda</span> <span class="n">neuron</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[</span>
</span><span id="DatasetBuilder.create_time_lags-456"><a href="#DatasetBuilder.create_time_lags-456"><span class="linenos">456</span></a>                    <span class="p">[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">,</span> <span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder.create_time_lags-457"><a href="#DatasetBuilder.create_time_lags-457"><span class="linenos">457</span></a>                <span class="p">]</span>
</span><span id="DatasetBuilder.create_time_lags-458"><a href="#DatasetBuilder.create_time_lags-458"><span class="linenos">458</span></a>                <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="DatasetBuilder.create_time_lags-459"><a href="#DatasetBuilder.create_time_lags-459"><span class="linenos">459</span></a>                    <span class="n">neuron</span><span class="p">[</span><span class="n">neuron</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># convert to series</span>
</span><span id="DatasetBuilder.create_time_lags-460"><a href="#DatasetBuilder.create_time_lags-460"><span class="linenos">460</span></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-461"><a href="#DatasetBuilder.create_time_lags-461"><span class="linenos">461</span></a>                    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">),</span>
</span><span id="DatasetBuilder.create_time_lags-462"><a href="#DatasetBuilder.create_time_lags-462"><span class="linenos">462</span></a>                    <span class="n">on</span><span class="o">=</span><span class="n">common_index</span><span class="p">,</span>
</span><span id="DatasetBuilder.create_time_lags-463"><a href="#DatasetBuilder.create_time_lags-463"><span class="linenos">463</span></a>                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="DatasetBuilder.create_time_lags-464"><a href="#DatasetBuilder.create_time_lags-464"><span class="linenos">464</span></a>                <span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-465"><a href="#DatasetBuilder.create_time_lags-465"><span class="linenos">465</span></a>                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="DatasetBuilder.create_time_lags-466"><a href="#DatasetBuilder.create_time_lags-466"><span class="linenos">466</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_stimuli</span><span class="p">()</span>
</span><span id="DatasetBuilder.create_time_lags-467"><a href="#DatasetBuilder.create_time_lags-467"><span class="linenos">467</span></a>                    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-468"><a href="#DatasetBuilder.create_time_lags-468"><span class="linenos">468</span></a>                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="DatasetBuilder.create_time_lags-469"><a href="#DatasetBuilder.create_time_lags-469"><span class="linenos">469</span></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;stimulus.length&quot;</span><span class="p">),</span>
</span><span id="DatasetBuilder.create_time_lags-470"><a href="#DatasetBuilder.create_time_lags-470"><span class="linenos">470</span></a>                    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span>
</span><span id="DatasetBuilder.create_time_lags-471"><a href="#DatasetBuilder.create_time_lags-471"><span class="linenos">471</span></a>                <span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-472"><a href="#DatasetBuilder.create_time_lags-472"><span class="linenos">472</span></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">common_index</span><span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-473"><a href="#DatasetBuilder.create_time_lags-473"><span class="linenos">473</span></a>                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stagger</span><span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-474"><a href="#DatasetBuilder.create_time_lags-474"><span class="linenos">474</span></a>            <span class="p">)</span>
</span><span id="DatasetBuilder.create_time_lags-475"><a href="#DatasetBuilder.create_time_lags-475"><span class="linenos">475</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p><code>tau</code>: length of window (in secs) to consider in prediction
<code>basis</code>: an instance of a class that inherits from
<code><a href="basisfunctions.html#Basis">preconstruct.basisfunctions.Basis</a></code>, initialized with the dimension
of the projection</p>

<h6 id="example">example</h6>

<!--



md5-39cb6607ac2b8d94487ab3c1b88db32d





-->

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn"><a href="basisfunctions.html">preconstruct.basisfunctions</a></span> <span class="kn">import</span> <span class="n">RaisedCosineBasis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">builder</span><span class="o">.</span><span class="n">create_time_lags</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">RaisedCosineBasis</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
</code></pre>
</div>
</div>


                            </div>
                            <div id="DatasetBuilder.pool_trials" class="classattr">
                                        <input id="DatasetBuilder.pool_trials-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pool_trials</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DatasetBuilder.pool_trials-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder.pool_trials"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder.pool_trials-502"><a href="#DatasetBuilder.pool_trials-502"><span class="linenos">502</span></a>    <span class="k">def</span> <span class="nf">pool_trials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DatasetBuilder.pool_trials-503"><a href="#DatasetBuilder.pool_trials-503"><span class="linenos">503</span></a>        <span class="sd">&quot;&quot;&quot;Pool spikes across trials&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder.pool_trials-504"><a href="#DatasetBuilder.pool_trials-504"><span class="linenos">504</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="DatasetBuilder.pool_trials-505"><a href="#DatasetBuilder.pool_trials-505"><span class="linenos">505</span></a>            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()</span>
</span><span id="DatasetBuilder.pool_trials-506"><a href="#DatasetBuilder.pool_trials-506"><span class="linenos">506</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">)[</span><span class="s2">&quot;stimulus.interval&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder.pool_trials-507"><a href="#DatasetBuilder.pool_trials-507"><span class="linenos">507</span></a>            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ser</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ser</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="DatasetBuilder.pool_trials-508"><a href="#DatasetBuilder.pool_trials-508"><span class="linenos">508</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="DatasetBuilder.pool_trials-509"><a href="#DatasetBuilder.pool_trials-509"><span class="linenos">509</span></a>        <span class="p">):</span>
</span><span id="DatasetBuilder.pool_trials-510"><a href="#DatasetBuilder.pool_trials-510"><span class="linenos">510</span></a>            <span class="k">raise</span> <span class="n">InconsistentStimulusInterval</span>
</span><span id="DatasetBuilder.pool_trials-511"><a href="#DatasetBuilder.pool_trials-511"><span class="linenos">511</span></a>
</span><span id="DatasetBuilder.pool_trials-512"><a href="#DatasetBuilder.pool_trials-512"><span class="linenos">512</span></a>        <span class="n">responses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_responses</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="DatasetBuilder.pool_trials-513"><a href="#DatasetBuilder.pool_trials-513"><span class="linenos">513</span></a>        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="DatasetBuilder.pool_trials-514"><a href="#DatasetBuilder.pool_trials-514"><span class="linenos">514</span></a>            <span class="k">raise</span> <span class="n">InvalidConstructionSequence</span><span class="p">(</span><span class="s2">&quot;bin_responses&quot;</span><span class="p">)</span>
</span><span id="DatasetBuilder.pool_trials-515"><a href="#DatasetBuilder.pool_trials-515"><span class="linenos">515</span></a>        <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
</span><span id="DatasetBuilder.pool_trials-516"><a href="#DatasetBuilder.pool_trials-516"><span class="linenos">516</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">_get_trial_data</span><span class="p">()[</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder.pool_trials-517"><a href="#DatasetBuilder.pool_trials-517"><span class="linenos">517</span></a>        <span class="p">)</span>
</span><span id="DatasetBuilder.pool_trials-518"><a href="#DatasetBuilder.pool_trials-518"><span class="linenos">518</span></a>        <span class="k">del</span> <span class="n">responses</span><span class="p">[</span><span class="s2">&quot;trial&quot;</span><span class="p">]</span>
</span><span id="DatasetBuilder.pool_trials-519"><a href="#DatasetBuilder.pool_trials-519"><span class="linenos">519</span></a>        <span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</span><span id="DatasetBuilder.pool_trials-520"><a href="#DatasetBuilder.pool_trials-520"><span class="linenos">520</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">responses</span> <span class="o">=</span> <span class="n">responses</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;stimulus.name&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
</span><span id="DatasetBuilder.pool_trials-521"><a href="#DatasetBuilder.pool_trials-521"><span class="linenos">521</span></a>            <span class="s2">&quot;sum&quot;</span>
</span><span id="DatasetBuilder.pool_trials-522"><a href="#DatasetBuilder.pool_trials-522"><span class="linenos">522</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Pool spikes across trials</p>
</div>


                            </div>
                            <div id="DatasetBuilder.get_dataset" class="classattr">
                                        <input id="DatasetBuilder.get_dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_dataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#Dataset">preconstruct.dataset.Dataset</a></span>:</span></span>

                <label class="view-source-button" for="DatasetBuilder.get_dataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DatasetBuilder.get_dataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DatasetBuilder.get_dataset-524"><a href="#DatasetBuilder.get_dataset-524"><span class="linenos">524</span></a>    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
</span><span id="DatasetBuilder.get_dataset-525"><a href="#DatasetBuilder.get_dataset-525"><span class="linenos">525</span></a>        <span class="sd">&quot;&quot;&quot;Return the fully constructed `Dataset` object&quot;&quot;&quot;</span>
</span><span id="DatasetBuilder.get_dataset-526"><a href="#DatasetBuilder.get_dataset-526"><span class="linenos">526</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span>
</span></pre></div>


            <div class="docstring"><p>Return the fully constructed <code><a href="#Dataset">Dataset</a></code> object</p>
</div>


                            </div>
                </section>
                <section id="InvalidConstructionSequence">
                            <input id="InvalidConstructionSequence-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">InvalidConstructionSequence</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="InvalidConstructionSequence-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InvalidConstructionSequence"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InvalidConstructionSequence-541"><a href="#InvalidConstructionSequence-541"><span class="linenos">541</span></a><span class="k">class</span> <span class="nc">InvalidConstructionSequence</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="InvalidConstructionSequence-542"><a href="#InvalidConstructionSequence-542"><span class="linenos">542</span></a>    <span class="sd">&quot;&quot;&quot;Indicates that the methods of a DatasetBuilder have been called in an invalid order&quot;&quot;&quot;</span>
</span><span id="InvalidConstructionSequence-543"><a href="#InvalidConstructionSequence-543"><span class="linenos">543</span></a>
</span><span id="InvalidConstructionSequence-544"><a href="#InvalidConstructionSequence-544"><span class="linenos">544</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_method</span><span class="p">):</span>
</span><span id="InvalidConstructionSequence-545"><a href="#InvalidConstructionSequence-545"><span class="linenos">545</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="InvalidConstructionSequence-546"><a href="#InvalidConstructionSequence-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">required_method</span> <span class="o">=</span> <span class="n">required_method</span>
</span><span id="InvalidConstructionSequence-547"><a href="#InvalidConstructionSequence-547"><span class="linenos">547</span></a>
</span><span id="InvalidConstructionSequence-548"><a href="#InvalidConstructionSequence-548"><span class="linenos">548</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="InvalidConstructionSequence-549"><a href="#InvalidConstructionSequence-549"><span class="linenos">549</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="InvalidConstructionSequence-550"><a href="#InvalidConstructionSequence-550"><span class="linenos">550</span></a>            <span class="sa">f</span><span class="s2">&quot;invalid construction sequence: must call `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">required_method</span><span class="si">}</span><span class="s2">` first&quot;</span>
</span><span id="InvalidConstructionSequence-551"><a href="#InvalidConstructionSequence-551"><span class="linenos">551</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Indicates that the methods of a DatasetBuilder have been called in an invalid order</p>
</div>


                            <div id="InvalidConstructionSequence.__init__" class="classattr">
                                        <input id="InvalidConstructionSequence.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">InvalidConstructionSequence</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">required_method</span></span>)</span>

                <label class="view-source-button" for="InvalidConstructionSequence.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InvalidConstructionSequence.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InvalidConstructionSequence.__init__-544"><a href="#InvalidConstructionSequence.__init__-544"><span class="linenos">544</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_method</span><span class="p">):</span>
</span><span id="InvalidConstructionSequence.__init__-545"><a href="#InvalidConstructionSequence.__init__-545"><span class="linenos">545</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="InvalidConstructionSequence.__init__-546"><a href="#InvalidConstructionSequence.__init__-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">required_method</span> <span class="o">=</span> <span class="n">required_method</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.BaseException</dt>
                                <dd id="InvalidConstructionSequence.with_traceback" class="function">with_traceback</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="IncompatibleTrialError">
                            <input id="IncompatibleTrialError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">IncompatibleTrialError</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="IncompatibleTrialError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IncompatibleTrialError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IncompatibleTrialError-554"><a href="#IncompatibleTrialError-554"><span class="linenos">554</span></a><span class="k">class</span> <span class="nc">IncompatibleTrialError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="IncompatibleTrialError-555"><a href="#IncompatibleTrialError-555"><span class="linenos">555</span></a>    <span class="sd">&quot;&quot;&quot;Raised when corresponding trials from different pprox files differ</span>
</span><span id="IncompatibleTrialError-556"><a href="#IncompatibleTrialError-556"><span class="linenos">556</span></a>
</span><span id="IncompatibleTrialError-557"><a href="#IncompatibleTrialError-557"><span class="linenos">557</span></a><span class="sd">    If the differing trial data is expected, you can choose to not include</span>
</span><span id="IncompatibleTrialError-558"><a href="#IncompatibleTrialError-558"><span class="linenos">558</span></a><span class="sd">    specific keys using the `ignore_columns` argument in</span>
</span><span id="IncompatibleTrialError-559"><a href="#IncompatibleTrialError-559"><span class="linenos">559</span></a><span class="sd">    `DatasetBuilder.load_responses`.</span>
</span><span id="IncompatibleTrialError-560"><a href="#IncompatibleTrialError-560"><span class="linenos">560</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="IncompatibleTrialError-561"><a href="#IncompatibleTrialError-561"><span class="linenos">561</span></a>
</span><span id="IncompatibleTrialError-562"><a href="#IncompatibleTrialError-562"><span class="linenos">562</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial_pair</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]):</span>
</span><span id="IncompatibleTrialError-563"><a href="#IncompatibleTrialError-563"><span class="linenos">563</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="IncompatibleTrialError-564"><a href="#IncompatibleTrialError-564"><span class="linenos">564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span> <span class="o">=</span> <span class="n">trial_pair</span>
</span><span id="IncompatibleTrialError-565"><a href="#IncompatibleTrialError-565"><span class="linenos">565</span></a>
</span><span id="IncompatibleTrialError-566"><a href="#IncompatibleTrialError-566"><span class="linenos">566</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="IncompatibleTrialError-567"><a href="#IncompatibleTrialError-567"><span class="linenos">567</span></a>        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="IncompatibleTrialError-568"><a href="#IncompatibleTrialError-568"><span class="linenos">568</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="IncompatibleTrialError-569"><a href="#IncompatibleTrialError-569"><span class="linenos">569</span></a>            <span class="sa">f</span><span class="s2">&quot;at least two trials contained conflicting data: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="IncompatibleTrialError-570"><a href="#IncompatibleTrialError-570"><span class="linenos">570</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span><span class="p">[</span><span class="n">b</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="IncompatibleTrialError-571"><a href="#IncompatibleTrialError-571"><span class="linenos">571</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Raised when corresponding trials from different pprox files differ</p>

<p>If the differing trial data is expected, you can choose to not include
specific keys using the <code>ignore_columns</code> argument in
<code><a href="#DatasetBuilder.load_responses">DatasetBuilder.load_responses</a></code>.</p>
</div>


                            <div id="IncompatibleTrialError.__init__" class="classattr">
                                        <input id="IncompatibleTrialError.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">IncompatibleTrialError</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">trial_pair</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="IncompatibleTrialError.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IncompatibleTrialError.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IncompatibleTrialError.__init__-562"><a href="#IncompatibleTrialError.__init__-562"><span class="linenos">562</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial_pair</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]):</span>
</span><span id="IncompatibleTrialError.__init__-563"><a href="#IncompatibleTrialError.__init__-563"><span class="linenos">563</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="IncompatibleTrialError.__init__-564"><a href="#IncompatibleTrialError.__init__-564"><span class="linenos">564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trial_pair</span> <span class="o">=</span> <span class="n">trial_pair</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.BaseException</dt>
                                <dd id="IncompatibleTrialError.with_traceback" class="function">with_traceback</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="InconsistentStimulusInterval">
                            <input id="InconsistentStimulusInterval-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">InconsistentStimulusInterval</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="InconsistentStimulusInterval-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InconsistentStimulusInterval"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InconsistentStimulusInterval-574"><a href="#InconsistentStimulusInterval-574"><span class="linenos">574</span></a><span class="k">class</span> <span class="nc">InconsistentStimulusInterval</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="InconsistentStimulusInterval-575"><a href="#InconsistentStimulusInterval-575"><span class="linenos">575</span></a>    <span class="sd">&quot;&quot;&quot;Raised when stimulus.interval differs between trials that are to be combined&quot;&quot;&quot;</span>
</span><span id="InconsistentStimulusInterval-576"><a href="#InconsistentStimulusInterval-576"><span class="linenos">576</span></a>
</span><span id="InconsistentStimulusInterval-577"><a href="#InconsistentStimulusInterval-577"><span class="linenos">577</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="InconsistentStimulusInterval-578"><a href="#InconsistentStimulusInterval-578"><span class="linenos">578</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="InconsistentStimulusInterval-579"><a href="#InconsistentStimulusInterval-579"><span class="linenos">579</span></a>            <span class="s2">&quot;if you want to pool trials, every stimulus presentation must have&quot;</span>
</span><span id="InconsistentStimulusInterval-580"><a href="#InconsistentStimulusInterval-580"><span class="linenos">580</span></a>            <span class="s2">&quot; the same stimulus.interval&quot;</span>
</span><span id="InconsistentStimulusInterval-581"><a href="#InconsistentStimulusInterval-581"><span class="linenos">581</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Raised when stimulus.interval differs between trials that are to be combined</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="InconsistentStimulusInterval.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="InconsistentStimulusInterval.with_traceback" class="function">with_traceback</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="IncompatibleStimulusSamplingRates">
                            <input id="IncompatibleStimulusSamplingRates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">IncompatibleStimulusSamplingRates</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="IncompatibleStimulusSamplingRates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IncompatibleStimulusSamplingRates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IncompatibleStimulusSamplingRates-584"><a href="#IncompatibleStimulusSamplingRates-584"><span class="linenos">584</span></a><span class="k">class</span> <span class="nc">IncompatibleStimulusSamplingRates</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="IncompatibleStimulusSamplingRates-585"><a href="#IncompatibleStimulusSamplingRates-585"><span class="linenos">585</span></a>    <span class="sd">&quot;&quot;&quot;Raised when it&#39;s not possible for all stimuli to have the desired time step&quot;&quot;&quot;</span>
</span><span id="IncompatibleStimulusSamplingRates-586"><a href="#IncompatibleStimulusSamplingRates-586"><span class="linenos">586</span></a>
</span><span id="IncompatibleStimulusSamplingRates-587"><a href="#IncompatibleStimulusSamplingRates-587"><span class="linenos">587</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="IncompatibleStimulusSamplingRates-588"><a href="#IncompatibleStimulusSamplingRates-588"><span class="linenos">588</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="IncompatibleStimulusSamplingRates-589"><a href="#IncompatibleStimulusSamplingRates-589"><span class="linenos">589</span></a>            <span class="s2">&quot;Stimuli have different sampling rates, and it&#39;s not possible for&quot;</span>
</span><span id="IncompatibleStimulusSamplingRates-590"><a href="#IncompatibleStimulusSamplingRates-590"><span class="linenos">590</span></a>            <span class="s2">&quot; them to all have the same time step&quot;</span>
</span><span id="IncompatibleStimulusSamplingRates-591"><a href="#IncompatibleStimulusSamplingRates-591"><span class="linenos">591</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Raised when it's not possible for all stimuli to have the desired time step</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="IncompatibleStimulusSamplingRates.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="IncompatibleStimulusSamplingRates.with_traceback" class="function">with_traceback</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="IncompatibleStimuliFormat">
                            <input id="IncompatibleStimuliFormat-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">IncompatibleStimuliFormat</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="IncompatibleStimuliFormat-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IncompatibleStimuliFormat"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IncompatibleStimuliFormat-594"><a href="#IncompatibleStimuliFormat-594"><span class="linenos">594</span></a><span class="k">class</span> <span class="nc">IncompatibleStimuliFormat</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="IncompatibleStimuliFormat-595"><a href="#IncompatibleStimuliFormat-595"><span class="linenos">595</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
</span><span id="IncompatibleStimuliFormat-596"><a href="#IncompatibleStimuliFormat-596"><span class="linenos">596</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="nb">format</span>
</span><span id="IncompatibleStimuliFormat-597"><a href="#IncompatibleStimuliFormat-597"><span class="linenos">597</span></a>
</span><span id="IncompatibleStimuliFormat-598"><a href="#IncompatibleStimuliFormat-598"><span class="linenos">598</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="IncompatibleStimuliFormat-599"><a href="#IncompatibleStimuliFormat-599"><span class="linenos">599</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="IncompatibleStimuliFormat-600"><a href="#IncompatibleStimuliFormat-600"><span class="linenos">600</span></a>            <span class="sa">f</span><span class="s2">&quot;the StimuliFormat you have picked (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="IncompatibleStimuliFormat-601"><a href="#IncompatibleStimuliFormat-601"><span class="linenos">601</span></a>            <span class="s2">&quot; is not a subclass of `SameTimeIndexAsResponse`&quot;</span>
</span><span id="IncompatibleStimuliFormat-602"><a href="#IncompatibleStimuliFormat-602"><span class="linenos">602</span></a>            <span class="s2">&quot; so you can&#39;t call this function&quot;</span>
</span><span id="IncompatibleStimuliFormat-603"><a href="#IncompatibleStimuliFormat-603"><span class="linenos">603</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Common base class for all non-exit exceptions.</p>
</div>


                            <div id="IncompatibleStimuliFormat.__init__" class="classattr">
                                        <input id="IncompatibleStimuliFormat.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">IncompatibleStimuliFormat</span><span class="signature pdoc-code condensed">(<span class="param"><span class="nb">format</span></span>)</span>

                <label class="view-source-button" for="IncompatibleStimuliFormat.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IncompatibleStimuliFormat.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IncompatibleStimuliFormat.__init__-595"><a href="#IncompatibleStimuliFormat.__init__-595"><span class="linenos">595</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
</span><span id="IncompatibleStimuliFormat.__init__-596"><a href="#IncompatibleStimuliFormat.__init__-596"><span class="linenos">596</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="nb">format</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.BaseException</dt>
                                <dd id="IncompatibleStimuliFormat.with_traceback" class="function">with_traceback</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="TimestepSetTwice">
                            <input id="TimestepSetTwice-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TimestepSetTwice</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="TimestepSetTwice-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimestepSetTwice"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimestepSetTwice-606"><a href="#TimestepSetTwice-606"><span class="linenos">606</span></a><span class="k">class</span> <span class="nc">TimestepSetTwice</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="TimestepSetTwice-607"><a href="#TimestepSetTwice-607"><span class="linenos">607</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TimestepSetTwice-608"><a href="#TimestepSetTwice-608"><span class="linenos">608</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;You can only set time_step once&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Common base class for all non-exit exceptions.</p>
</div>


                            <div id="TimestepSetTwice.__init__" class="classattr">
                                        <input id="TimestepSetTwice.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TimestepSetTwice</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="TimestepSetTwice.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TimestepSetTwice.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TimestepSetTwice.__init__-607"><a href="#TimestepSetTwice.__init__-607"><span class="linenos">607</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TimestepSetTwice.__init__-608"><a href="#TimestepSetTwice.__init__-608"><span class="linenos">608</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;You can only set time_step once&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.BaseException</dt>
                                <dd id="TimestepSetTwice.with_traceback" class="function">with_traceback</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>